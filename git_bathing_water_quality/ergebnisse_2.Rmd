---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---


```{r message=FALSE, warning=FALSE, include=FALSE}
#check random forest
#for new river instanziere this
river_stat_model_save <- data.frame()
river_fmla_save <-list()
river_fb_save <-data.frame()
error_df_algorithms_save<- data.frame(5)
rf_var_df_save <- data.frame(5)
step_var_df_save<- data.frame(5)

lasso_var_lambda_1se_save <- data.frame(5)
elnet_var_lambda_1se_save <- data.frame(5)
lasso_var_lambda_min_save <- data.frame(5)
elnet_var_lambda_min_save<- data.frame(5)
{    #preload packages
  {
    library(broom)
    library(caret)
    library(magrittr)
    library(randomForest)
    library(dplyr)
    library(glmnet)
    library(purrr)
    library(tidyverse)
    #?glmnet
    library(phonTools)
    library(coefplot) #for extracing non 0 coef
    #install.packages("tidyverse")
    library(tidyverse)
    library(pROC)
    library(fhpredict)
    library(tidyverse)
    library(Boruta)
    
    library(kwb.flusshygiene)
  }
  #functions
  {
    get_coef_1se_cv <- function(df){
      tmp_coeffs <- coef(df, s = "lambda.1se")
      a <- data.frame(name = tmp_coeffs@Dimnames[[1]][tmp_coeffs@i + 1], coefficient = tmp_coeffs@x)
      return(a)
    }
    get_coef_min_cv <- function(df){
      tmp_coeffs <- coef(df, s = "lambda.min")
      a <- data.frame(name = tmp_coeffs@Dimnames[[1]][tmp_coeffs@i + 1], coefficient = tmp_coeffs@x)
      return(a)
    }
    get_coef_fixed_lambda <- function(df,lambda){
      tmp_coeffs <- coef(df, s = lambda)
      a <- data.frame(name = tmp_coeffs@Dimnames[[1]][tmp_coeffs@i + 1], coefficient = tmp_coeffs@x)
      return(a)
    }
    get_formula_variable_names <- function(formula_a,df){ 
      mf <- model.frame(formula_a, data=df)
      mt <- attr(mf, "terms")
      predvarnames <- attr(mt, "term.labels")
      predvarnames
    }
    limit_max_features <- function(fmla_list, data = data_train){
      for (formla in 1:length(fmla_list)) {
        #formla = 3
        #fmla_list<- list_lasso
        if((length(all.vars(fmla_list[[formla]]))-1)> floor(nrow(data)/2)){ 
          fmla_list <- fmla_list[-formla]
          print("fmla remove because of two many features compared to datapoint")
        }
        return(fmla_list)
      }
    }
    get_feature_selection_coeficient_names_as_formular_1se <- function(algorithm_list){
      #fit_lasso_base_cross
      #algorithm_list<-fit_lasso_base_cross
      coef_1se<- get_coef_1se_cv(algorithm_list)
      if(dim(coef_1se)[1]==1){
        print("only intercept. nothing to model")
      }else{
        coef_name_lambda_1se<-coef_1se$name[-1]
        #a<-str("")
        coefficients<-paste(coef_name_lambda_1se, collapse = " + " )
        
        formel<-paste("log_e.coli ~ ", coefficients)
        formel
        formula_from_selector<-formula(formel)
      }
      return(formula_from_selector)
    }
    get_feature_selection_coeficient_names_as_formular_lambda_min <- function(algorithm_list){
      #algorithm_list<-fit_lasso_base_cross
      coef_lambda_min<- get_coef_min_cv(algorithm_list)
      coef_name_lambda_min<-coef_lambda_min$name[-1]
      #a<-str("")
      coefficients<-paste(coef_name_lambda_min, collapse = " + " )
      formel<-paste("log_e.coli ~ ", coefficients)
      formula_from_selector<-formula(formel)
      return(formula_from_selector)
    } 
    calc_t <- function (datalist=river_data$havel, onlysummer) {
      #heiko
      #datalist<- river_data1$havel
      phy_data <- datalist[-1] # Entfernung der Hygienedaten
      
      if(onlysummer==T){
        hyg_df <- subset(datalist[[1]],
                         subset = lubridate::month(datum) %in% 5:9) # Filtern nach Sommer, warum hier 5:9 und beim anderen 4:9?
        
        data_summer <- lapply(phy_data, function(df){
          
          df <- subset(df, subset = lubridate::month(datum) %in% 4:9) 
        }
        )
      }  
      
      
      # z_standardize <- function (x) {
      
      #   y = (x - mean(x, na.rm=T))/sd(x, na.rm=T)
      
      # }
      
      log_transorm_rain <- function(df) { #log transforming rain data
        
        for (site in names(df)[-1]) { # every col gets treatment
          
          df2 <- subset(df, select = c("datum", site))
          
          if (grepl("^r_.*",site)) { # rain gets log-transformed and 1/sigma2
            
            df2[[site]] <- log(df2[[site]]+1)
            
            # df2[[site]] <- df2[[site]]/sd(df2[[site]], na.rm=T)
            
          } #else {
          
          #   df[[site]] <- z_standardize(df2[[site]]) # standardize
          
          # }
          
          df[[site]] <- df2[[site]]
          
        }
        
        return(df)
        
      }
      
      data_t <- lapply(data_summer, log_transorm_rain)
      
      result <- append(list(hyg_df), data_t)
      
      names(result) <- names(datalist)
      
      return(result)
      
    }
    ### Anwenden von calc_t auf Inputliste
    
 
    
    stepwise <- function (river, pattern, data1, null1, full1 ){
      # Definition maximum number of steps
      
      nsteps <- 5 #ifelse(round(nrow(data)/10) < 10, round(nrow(data)/10), 5 )
      
      selection <- list()
      
      fmla <- list()
      
      
      
      # Creating list of candidate models with 1 ...n predictors 
      #split up this piece in stpe and new algorithms/formulars
      
      for(i in 1: nsteps){
        
        
        
        selection[[i]] <- step(null1, data = data1,
                               
                               direction = "forward",
                               
                               list(lower=null1, upper=full1), steps = i)   
        
        
        fmla[[i]] <- as.list(selection[[i]]$call)$formula
        
        
        
      }
      
      #heiko_add_formular to fmla list function function
      #selection[[6]] <- heiko_lm
      #fmla[[6]] <- as.list(selection[[6]]$call)$formula
      step_returns <- list(fmla, selection)
      return(step_returns)
      
    }
    prediction_and_mse<- function(model1, test1, test_bacteria1){
      #model1<-rf_model_1
      #rf_formula_1
      
      #step_model_1
      #test_bacteria1 = test_bacteria
      #test1 = test
      #test_bacteria = test_bacteria
      
      prediction<- predict(object = model1, newdata = test1)
      return(mean(sqrt((test_bacteria1 - prediction)^2)))
    }
    
    calc_n_features <- function(df){
      #df<-step_df_1_coef_save 
      if(ncol(df)== 4){
        u <- 1
      }else{ 
        u <- rowSums(df[,-c((ncol(df)),(ncol(df)-1),(ncol(df)-2))])
      }
      df$n_features<- u
      return(df)
    }
    build_formula <- function( feature_list,bacteria = "log_e.coli~ " ){
      #feature_list<-imp_rf[1,2]
      formel <- feature_list[1]
      #formel1 <- feature_list[1,]
      if(length(feature_list)>1){
        for (idx in 2: length(feature_list)) {
          #element<-feature_list[2,]
          formel <- paste(formel, feature_list[[idx]], sep=" + ")
        }
      }  
      formel_with_bacteria<- as.formula(paste(bacteria, formel, sep=""))
      formellsit<-c(formel_with_bacteria,formel)
      
      return(formellsit)
    }
    
    get_new_iteration_row<-function(df_save,var_list){
      #df_save<-rf_df_1_coef
      #var_list<- rf_formula_11
      #df_save<-step_df_5_coef
      #names(df_save)<- names(rf_df_2_coef)
      #  var_list <-var_rf_model_3
      #var_list<-var_step_model_5
      #var_list<-var_rf_model_5
      #all(sapply(var_list, is.character))
      #df_save<-lasso_df_3_coef
      #var_list<-unique_lasso_formulas_coef_3
      
      #list_unqiue_formulas_all_algorithms
      
      o<-var_list #adds the formula
      
      if(all(sapply(var_list, is.character))==F){
        o<- o[[2]][1]
      }
      
      new_row <- data.frame(matrix(0, ncol = length((colnames(df_with_all_variable_names)))+2, nrow = 1))
      colnames(new_row)<- colnames(df_with_all_variable_names)
      new_row[ncol(new_row)-1] <- o
      names(new_row)[length(names(new_row))-1]<-"formel"
      new_row[ncol(new_row)] <- j
      names(new_row)[length(names(new_row))]<-"split_id"
      #check for variables
      a<-strsplit( o, split = " \\+ ")
      
      #add a 1 in var_column if formula contains variable
      for (idx in 1:length(a[[1]])) {
        #idx = 3
        if(grepl(':',a[[1]][idx] )){ #sometimes, step changes order of variables with interaction
          string1<-a[[1]][idx]
          new_string_list<-str_split(string1,":")
          string2 <- paste(new_string_list[[1]][2],new_string_list[[1]][1], sep = ":")
          i<-paste("^",string1, "$", sep = "")
          j<-paste("^",string2, "$", sep = "")
          indx1 <- grepl(i, colnames(df_save))
          indx2 <- grepl(j, colnames(df_save))
          new_row[1,indx1]=1
          new_row[1,indx2]=1
          
        }else{
          i<-paste("^",a[[1]][idx], "$", sep = "")
          
          indx <- grepl(i, colnames(df_save))
          #   any(indx)
          new_row[1,indx]=1
        }
        
      }
      
      #select(new_row,q_mean_mean_12, ka_mean_mean_45, ka_mean_mean_34,'ka_mean_mean_45:q_mean_mean_12')
      return(new_row)
      
    }
    remove_all_cols_that_are_zero <- function(df){
      #df<-a
      no_zero_df<-df[,apply(df,2,function(df) !all(df==0))]
      no_zero_df<- no_zero_df[-1,]
      return(no_zero_df)
    }
    #instanzierung df for 1 iteration
    build_rename_cols_to_variable_names <- function(df_with_all_vars){
      df<-data.frame(matrix(0, ncol = length((colnames(df_with_all_vars)))+2, nrow = 1))
      colnames(df)<- colnames(df_with_all_vars)
      names(df)[length(names(df))-1]<-"formel" 
      names(df)[length(names(df))]<-"split_id" 
      
      
      return(df)
    }
      paste_together_step_coefficients<-function(var_step_model_function ){
        #var_step_model_function <- var_step_model_3
        #var_step_model_function[1:3]
        #var_step_model_function <- var_step_model_function[[2:length(var_step_model_function)]]
        formel<- var_step_model_function[[1]]
        if(length(var_step_model_function)> 1){
          for (entry in 2:length(var_step_model_function)) {
            formel<-paste(formel, var_step_model_function[entry], sep = " + ")
          }
        }
        return(formel)
      } 
    
  }
  
  #data
  {
    
    first_time_model_train <- 1
    
    rivers <- c("havel")
    river <- "havel"
    #river_paths <- kwb.flusshygiene::get_paths()[paste0(rivers, "data")]
    
    #river_paths <- list(havel = "Y:/SUW_Department/Projects/FLUSSHYGIENE/Data-Work packages/Daten/Daten_TestPackage_Berlin/Havel/DATA_preprocessed_csv")
    
    #river_paths <- list(havel = "/Users/heiko.langer/Masterarbeit_lokal/Data_preprocess/Daten_TestPackage_Berlin/Havel/DATA_preprocessed_csv" )
    river_paths <- list(havel = "/Users/heiko.langer/Masterarbeit_lokal/Data_preprocess/Daten_Bayern/Isar/DATA_preprocessed_csv")
    #river_paths <- list(havel = "/Users/heiko.langer/Masterarbeit_lokal/Data_preprocess/Daten_Bayern/Ilz/DATA_preprocessed_csv" )
  
    #river_paths<-list(havel = "/Users/heiko.langer/Masterarbeit_lokal/Data_preprocess/Daten_Rhein_Mosel_Lahn/Mosel/DATA_preprocessed_csv")
    #river_paths<-list(havel = "/Users/heiko.langer/Masterarbeit_lokal/Data_preprocess/Daten_Rhein_Mosel_Lahn/Rhein/DATA_preprocessed_csv")
    
    #river_paths<-list(havel = "/Users/heiko.langer/Masterarbeit_lokal/Data_preprocess/Daten_Ruhr/Ruhr/DATA_preprocessed_csv")
    }
  { 
  river_data <- lapply(river_paths, kwb.flusshygiene::import_riverdata)
  
  #river <- "Isar"
  
  names(river_data) <- rivers
  
  #if (FALSE)
  #turn to False if not wanted   
  #set.seed(5)
  river_data_ts <- lapply(river_data, function(river_list){
    
    river_ts <- calc_t(river_list, onlysummer = T) # use function
    
    add_meancol <- function (df) { # for rain and i #edit: + ka #2ndedit: + q
      
      prefix <- unique(sub("([a-z])_.*","\\1",names(df)[-1]))
      
      for (pre in prefix) {
        
        df2 <- dplyr::select(df, dplyr::starts_with(pre))
        
        df[,paste0(pre,"_mean")] <- rowMeans(df2, na.rm=T)
        
      }
      
      
      
      return(df)
      
    }
    
    add_sumcol <- function (df) { # originally for ka, but not used
      
      prefix <- unique(sub("([a-z])_.*","\\1",names(df)[-1]))
      
      if (length(df) > 2)
        
        df[,paste0(prefix,"_sum")] <- rowSums(df[,-1], na.rm=T)
      
      return(df)
      
    }
    
    
    
    q_pos <- grep("^q", names(river_ts)[-1])+1
    
    
    if (length(q_pos) == 1)
      
      river_ts[[q_pos]] <- add_meancol(river_ts[[q_pos]])
    
    ka_pos <- grep("^ka", names(river_ts)[-1])+1
    
    if (length(ka_pos) == 1)
      
      river_ts[[ka_pos]] <- add_meancol(river_ts[[ka_pos]])
    
    i_pos <- grep("^i", names(river_ts)[-1])+1
    
    if (length(i_pos) == 1)
      
      river_ts[[i_pos]] <- add_meancol(river_ts[[i_pos]])
    
    r_pos <- grep("^r", names(river_ts)[-1])+1
    
    river_ts[[r_pos]] <- add_meancol(river_ts[[r_pos]])
    
    return(river_ts)
    
  })  
  }
}
#run here
#for (iterations in 1:10) {
  iterations <-1
  new_train_test_split <-T
  random_number <- set.seed(iterations)

  #river = "havel"
  pattern = "(i_mean|q_mean_mean|r_mean_mean|ka_mean_mean)"

  riverdata <- river_data_ts[[river]]
  
  # prepare variables out of all cominations (given by pattern)
  
  # variables for interaction get replaced by q_new (remove q_old)
  
  vars1 <- (riverdata[-1] %>% unroll_physical_data() %>%
              
              lapply(names) %>% unlist() %>% unique())[-1]
  
  vars2 <- vars1[stringr::str_detect(vars1, pattern)]
  
  
  
  # prepare formulas
  
  data <- process_model_riverdata(riverdata, c("log_e.coli", vars2)) %>%  dplyr::select(-datum) 
  data <- na.omit(data)
  #scaled_data
  data <-data.frame(scale(data))
  
  #train/test split for datavalidation
  train_index <- sample(1:nrow(data), 0.8 * nrow(data))
  test_index <- setdiff(1:nrow(data), train_index)
  
  data_train<-data[train_index,]
  data_test <- data[test_index,]
  #stepwise models
  null <- lm(log_e.coli ~ 1, data = data_train) #model with only 1 variable
  
  full <- lm(log_e.coli ~ .^2, data = data_train)


  bacteria<-names(data_train)[1]
  form<-formula(paste(bacteria," ~ .^2"))
    
  
  test_rows <- list()
  datapoints<-seq(1, nrow(data_train))
  
    #foldid
  if(new_train_test_split ==T){
    train_rows <- list()
    foldid=sample(rep(seq(5),length=nrow(data_train)))  #fixes the train/test for cv.glmnet
    train_rows<- list()
      for (fold in 1:5) {
        train_rows[[fold]]<-datapoints[foldid!=fold]  
      }
  }
    
    #data
    train <- model.matrix(full, data_train)
    df_with_all_variable_names <-train

    train_sparse <- sparse.model.matrix(full, data_train) #data must be dataframe
    

        
          
        
    #instanzieren variables
    elnet_var_lambda_1se<-lasso_var_lambda_1se<-elnet_var_lambda_min<-lasso_var_lambda_min<-data.frame()
    rf_var_df<-step_var_df <- data.frame(5)
      
          
    r2_list_step_1<-r2_list_step_2<-r2_list_step_3<-r2_list_step_4<-r2_list_step_5<-r2_list_rf_1<-r2_list_rf_2<-r2_list_rf_3<-r2_list_rf_4<-r2_list_rf_5<-mse_list_rf_1<-mse_list_rf_2<-mse_list_rf_3<-mse_list_rf_4<-mse_list_rf_5<-mse_list_step_1<-    mse_list_step_2<-    mse_list_step_3<-    mse_list_step_4<-    mse_list_step_5 <-mse_list_rf <- list()
          

          
    rf_df_1_coef <- build_rename_cols_to_variable_names(df_with_all_variable_names)
    rf_df_2_coef <- build_rename_cols_to_variable_names(df_with_all_variable_names)
    rf_df_3_coef<- build_rename_cols_to_variable_names(df_with_all_variable_names)
    rf_df_4_coef<- build_rename_cols_to_variable_names(df_with_all_variable_names)
    rf_df_5_coef<- build_rename_cols_to_variable_names(df_with_all_variable_names)
    
    step_df_1_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
    step_df_2_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
    step_df_3_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
    step_df_4_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
    step_df_5_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
    #cross-auswahl
    
    for(j in 1:5){
    #  j=2
      
      train_bacteria <- data_train[train_rows[[j]],]$log_e.coli
      train <- data_train[train_rows[[j]],-1] #without e.coli
      train_rf <- model.matrix(form, data_train[train_rows[[j]],])
      
      test_bacteria <- data_train[-c(train_rows[[j]]),]$log_e.coli
      test <- data_train[-c(train_rows[[j]]),-1]
      test_rf <- model.matrix(form, data_train[-c(train_rows[[j]]),])
      #train_glmnet <- model.matrix(form, train)
      
      #train <- model.matrix(log_e.coli~.^2, data = data)
      #train_sparse_glmnet <- sparse.model.matrix(form, train) #data must be dataframe
      
      #set name for iteration
      iteration_name<-paste("iterations", iterations,"fold",j,sep = "_")
      
      
   
    
      null <- lm(log_e.coli ~ 1, data = data_train[train_rows[[j]],]) #model with only 1 variable
      
      full <- lm(log_e.coli ~ .^2, data = data_train[train_rows[[j]],])
      
      step_returns <- stepwise(river = river, pattern = "(i_mean|q_mean_mean|r_mean_mean|ka_mean_mean)", data = data_train[train_rows[[j]],],null, full)
      fmla <- step_returns[[1]]
      selection <- step_returns[[2]]
      
      step_model_1<-step_returns[[2]][[1]]
      step_model_2<-step_returns[[2]][[2]]
      step_model_3<-step_returns[[2]][[3]]
      step_model_4<-step_returns[[2]][[4]]
      step_model_5<-step_returns[[2]][[5]]
      
      
      var_step_model_1<- names(selection[[1]]$coefficients)[-1]
      var_step_model_2<-names(selection[[2]]$coefficients)[-1]
      var_step_model_3<-names(selection[[3]]$coefficients)[-1]
      var_step_model_4<-names(selection[[4]]$coefficients)[-1]
      var_step_model_5<-names(selection[[5]]$coefficients)[-1]
      
      
      
      var_step_model_1<- paste_together_step_coefficients(var_step_model_1)
      var_step_model_2<-paste_together_step_coefficients(var_step_model_2)
      var_step_model_3<-paste_together_step_coefficients(var_step_model_3)
      var_step_model_4<-paste_together_step_coefficients(var_step_model_4)
      var_step_model_5<-paste_together_step_coefficients(var_step_model_5)
      
      #new row
      
      new_row_step_df_1_coef <- get_new_iteration_row(step_df_1_coef, var_step_model_1 )
      new_row_step_df_2_coef <- get_new_iteration_row(step_df_2_coef, var_step_model_2 )
      new_row_step_df_3_coef <- get_new_iteration_row(step_df_3_coef, var_step_model_3 )
      new_row_step_df_4_coef <- get_new_iteration_row(step_df_4_coef, var_step_model_4 )
      new_row_step_df_5_coef <- get_new_iteration_row(step_df_5_coef, var_step_model_5 )
      #sum(new_row_step_df_5_coef==1)
      
      #name new column
      row.names(new_row_step_df_1_coef) <- iteration_name
      row.names(new_row_step_df_2_coef) <- iteration_name
      row.names(new_row_step_df_3_coef) <- iteration_name
      row.names(new_row_step_df_4_coef) <- iteration_name
      row.names(new_row_step_df_5_coef) <- iteration_name
      
      #add new train row
      step_df_1_coef<-rbind(step_df_1_coef, new_row_step_df_1_coef)
      step_df_2_coef<-rbind(step_df_2_coef, new_row_step_df_2_coef)
      step_df_3_coef<-rbind(step_df_3_coef, new_row_step_df_3_coef)
      step_df_4_coef<-rbind(step_df_4_coef, new_row_step_df_4_coef)
      step_df_5_coef<-rbind(step_df_5_coef, new_row_step_df_5_coef)
      
      #remove all columns that areonly 0
      # coefficients that a selected from
      step_df_1_coef_save <-remove_all_cols_that_are_zero(step_df_1_coef)
      step_df_2_coef_save <-remove_all_cols_that_are_zero(step_df_2_coef)
      step_df_3_coef_save <-remove_all_cols_that_are_zero(step_df_3_coef)
      step_df_4_coef_save <-remove_all_cols_that_are_zero(step_df_4_coef)
      step_df_5_coef_save <-remove_all_cols_that_are_zero(step_df_5_coef)
      
      
      
      
      step_var_df_fold <- setNames(data.frame(rbind(var_step_model_1,var_step_model_2,var_step_model_3,var_step_model_4,var_step_model_5)), iteration_name)
      step_var_df <- cbind(step_var_df,step_var_df_fold)

      
      
      
      mse_step_1_fold <- prediction_and_mse(step_model_1, test1 = test, test_bacteria1 = test_bacteria)
      mse_step_2_fold <- prediction_and_mse(step_model_2, test1 = test, test_bacteria1 = test_bacteria)
      mse_step_3_fold <- prediction_and_mse(step_model_3, test1 = test, test_bacteria1 = test_bacteria)
      mse_step_4_fold <- prediction_and_mse(step_model_4, test1 = test, test_bacteria1 = test_bacteria)
      mse_step_5_fold <- prediction_and_mse(step_model_5, test1 = test, test_bacteria1 = test_bacteria)
      
      r2_step_model_1_fold<-summary(step_model_1)[["adj.r.squared"]]
      r2_step_model_2_fold<-summary(step_model_2)[["adj.r.squared"]]
      r2_step_model_3_fold<-summary(step_model_3)[["adj.r.squared"]]
      r2_step_model_4_fold<-summary(step_model_4)[["adj.r.squared"]]
      r2_step_model_5_fold<-summary(step_model_5)[["adj.r.squared"]]
      
      mse_list_step_1<- append(mse_list_step_1,mse_step_1_fold)
      mse_list_step_2<- append(mse_list_step_2,mse_step_2_fold)
      mse_list_step_3<- append(mse_list_step_3,mse_step_3_fold)
      mse_list_step_4<- append(mse_list_step_4,mse_step_4_fold)
      mse_list_step_5<- append(mse_list_step_5,mse_step_5_fold)
      
      r2_list_step_1<- append(r2_list_step_1,r2_step_model_1_fold )
      r2_list_step_2<- append(r2_list_step_2,r2_step_model_2_fold )
      r2_list_step_3<- append(r2_list_step_3,r2_step_model_3_fold )
      r2_list_step_4<- append(r2_list_step_4,r2_step_model_4_fold )
      r2_list_step_5<- append(r2_list_step_5,r2_step_model_5_fold )
      
      
      
      
      
      #rfModel<-randomForest(x=train,  y=train_bacteria, xtest = test, ytest =  test_bacteria, importance = T, keep.forest = T )
      rfModel<-randomForest(train_rf, y = train_bacteria, na.rm =T, keep.forest = T) 
      
      imp_rf <- as.data.frame(varImp(rfModel, scale=T))
      
      imp_rf <- data.frame(overall = imp_rf$Overall,
                           names   = rownames(imp_rf))
      imp_rf<-imp_rf[order(imp_rf$overall,decreasing = T),]
      
      
      
      
      rf_formula_11<-build_formula(imp_rf[1,2])
      rf_formula_21<-build_formula(imp_rf[1:2,2])
      rf_formula_31<-build_formula(imp_rf[1:3,2])
      rf_formula_41<-build_formula(imp_rf[1:4,2])
      rf_formula_51<-build_formula(imp_rf[1:5,2])
      
      var_rf_model_1 <-  rf_formula_11[[2]]
      var_rf_model_2 <- rf_formula_21[[2]]
      var_rf_model_3 <- rf_formula_31[[2]]
      var_rf_model_4 <- rf_formula_41[[2]]
      var_rf_model_5 <- rf_formula_51[[2]]
      
     
      #add new row for every fold
      new_row_rf_df_1_coef <- get_new_iteration_row(rf_df_1_coef, rf_formula_11)
      new_row_rf_df_2_coef <- get_new_iteration_row(rf_df_2_coef, rf_formula_21)
      new_row_rf_df_3_coef <- get_new_iteration_row(rf_df_3_coef, rf_formula_31)
      new_row_rf_df_4_coef <- get_new_iteration_row(rf_df_4_coef, rf_formula_41)
      new_row_rf_df_5_coef <- get_new_iteration_row(rf_df_5_coef, rf_formula_51)
     
      iteration_name<-paste("iterations", iterations,"fold",j,sep = "_")
      #naming_new_row
      row.names(new_row_rf_df_1_coef) <- iteration_name
      row.names(new_row_rf_df_2_coef) <- iteration_name
      row.names(new_row_rf_df_3_coef) <- iteration_name
      row.names(new_row_rf_df_4_coef) <- iteration_name
      row.names(new_row_rf_df_5_coef) <- iteration_name
        #bind new row to df
      rf_df_1_coef<-rbind(rf_df_1_coef, new_row_rf_df_1_coef)
      rf_df_2_coef<-rbind(rf_df_2_coef, new_row_rf_df_2_coef)
      rf_df_3_coef<-rbind(rf_df_3_coef, new_row_rf_df_3_coef)
      rf_df_4_coef<-rbind(rf_df_4_coef, new_row_rf_df_4_coef)
      rf_df_5_coef<-rbind(rf_df_5_coef, new_row_rf_df_5_coef)
      
      
    
      
    
    
    
    rf_df_1_coef_save <-remove_all_cols_that_are_zero(rf_df_1_coef)
    rf_df_2_coef_save <-remove_all_cols_that_are_zero(rf_df_2_coef)
    rf_df_3_coef_save <-remove_all_cols_that_are_zero(rf_df_3_coef)
    rf_df_4_coef_save <-remove_all_cols_that_are_zero(rf_df_4_coef)
    rf_df_5_coef_save <-remove_all_cols_that_are_zero(rf_df_5_coef)
    
    
    
    
    #x<-rf_df_2_coef #remove all cols that are 0
      #rf_df_2_save<-x[,apply(x,2,function(x) !all(x==0))]
      
      
      
      #rf_df_2_coef_fold$n_coeff <-count_coefficients( var_rf_model_2)
      
      
      
      #save random forest variables here
      #rf_var_df <- data.frame(var_rf_model_1,var_rf_model_2,var_rf_model_3,var_rf_model_4,var_rf_model_5)
      
      
      
      
      rf_formula_1<- rf_formula_11[[1]]
      rf_formula_2<- rf_formula_21[[1]]
      rf_formula_3<- rf_formula_31[[1]]
      rf_formula_4<- rf_formula_41[[1]]
      rf_formula_5<- rf_formula_51[[1]]
      #build train test for rf_formulas
      train_rf_1 <- model.matrix(rf_formula_1,data_train[train_rows[[j]],])
      test_rf_1 <- model.matrix(rf_formula_1,data_train[-c(train_rows[[j]]),])
      
      train_rf_2 <- model.matrix(rf_formula_2,data_train[train_rows[[j]],])
      test_rf_2 <- model.matrix(rf_formula_2,data_train[-c(train_rows[[j]]),])
      
      train_rf_3 <- model.matrix(rf_formula_3,data_train[train_rows[[j]],])
      test_rf_3 <- model.matrix(rf_formula_3,data_train[-c(train_rows[[j]]),])
      
      train_rf_4 <- model.matrix(rf_formula_4,data_train[train_rows[[j]],])
      test_rf_4 <- model.matrix(rf_formula_4,data_train[-c(train_rows[[j]]),])
      
      train_rf_5 <- model.matrix(rf_formula_5,data_train[train_rows[[j]],])
      test_rf_5 <- model.matrix(rf_formula_5,data_train[-c(train_rows[[j]]),])
      
      do_rf_with_rf <-F #if false than features found by rf are used to build linear model like step
      if(do_rf_with_rf ==T){
        rf_model_1<-randomForest(train_rf_1,y = train_bacteria, na.rm =T, keep.forest = T)
        rf_model_2<-randomForest(train_rf_2,y = train_bacteria, na.rm =T, keep.forest = T)
        rf_model_3<-randomForest(train_rf_3,y = train_bacteria, na.rm =T, keep.forest = T)
        rf_model_4<-randomForest(train_rf_4,y = train_bacteria, na.rm =T, keep.forest = T)
        rf_model_5<-randomForest(train_rf_5,y = train_bacteria, na.rm =T, keep.forest = T)
        
        mse_rf_model_1_fold <- prediction_and_mse(rf_model_1, test1 = test_rf_1, test_bacteria = test_bacteria)
        mse_rf_model_2_fold <- prediction_and_mse(rf_model_2, test1 = test_rf_2, test_bacteria = test_bacteria)
        mse_rf_model_3_fold <- prediction_and_mse(rf_model_3, test1 = test_rf_3, test_bacteria = test_bacteria)
        mse_rf_model_4_fold <- prediction_and_mse(rf_model_4, test1 = test_rf_4, test_bacteria = test_bacteria)
        mse_rf_model_5_fold <- prediction_and_mse(rf_model_5, test1 = test_rf_5, test_bacteria = test_bacteria)
      }
      else{
        
        rf_model_1<-lm(rf_formula_1, data_train[train_rows[[j]],])
        rf_model_2<-lm(rf_formula_2, data_train[train_rows[[j]],])
        rf_model_3<-lm(rf_formula_3, data_train[train_rows[[j]],])
        rf_model_4<-lm(rf_formula_4, data_train[train_rows[[j]],])
        rf_model_5<-lm(rf_formula_5, data_train[train_rows[[j]],])
        
        #summary(rf_model_1)[["adj.r.squared"]]
        #summary(step_model_1)[["adj.r.squared"]]
        #summary(rf_model_1)
       #5fold-cross validation on test_data
        mse_rf_model_1_fold <- prediction_and_mse(rf_model_1, test1 = test, test_bacteria1 = test_bacteria)
        mse_rf_model_2_fold <- prediction_and_mse(rf_model_2, test1 = test, test_bacteria1 = test_bacteria)
        mse_rf_model_3_fold <- prediction_and_mse(rf_model_3, test1 = test, test_bacteria1 = test_bacteria)
        mse_rf_model_4_fold <- prediction_and_mse(rf_model_4, test1 = test, test_bacteria1 = test_bacteria)
        mse_rf_model_5_fold <- prediction_and_mse(rf_model_5, test1 = test, test_bacteria1 = test_bacteria)
        
        r2_rf_model_1_fold<-summary(rf_model_1)[["adj.r.squared"]]
        r2_rf_model_2_fold<-summary(rf_model_2)[["adj.r.squared"]]
        r2_rf_model_3_fold<-summary(rf_model_3)[["adj.r.squared"]]
        r2_rf_model_4_fold<-summary(rf_model_4)[["adj.r.squared"]]
        r2_rf_model_5_fold<-summary(rf_model_5)[["adj.r.squared"]]
        
      }
      
      
      
      mse_list_rf_1<- append(mse_list_rf_1,mse_rf_model_1_fold )
      mse_list_rf_2<- append(mse_list_rf_2,mse_rf_model_2_fold )
      mse_list_rf_3<- append(mse_list_rf_3,mse_rf_model_3_fold )
      mse_list_rf_4<- append(mse_list_rf_4,mse_rf_model_4_fold )
      mse_list_rf_5<- append(mse_list_rf_5,mse_rf_model_5_fold )
      
      r2_list_rf_1<- append(r2_list_rf_1,r2_rf_model_1_fold )
      r2_list_rf_2<- append(r2_list_rf_2,r2_rf_model_2_fold )
      r2_list_rf_3<- append(r2_list_rf_3,r2_rf_model_3_fold )
      r2_list_rf_4<- append(r2_list_rf_4,r2_rf_model_4_fold )
      r2_list_rf_5<- append(r2_list_rf_5,r2_rf_model_5_fold )
      
      
      
      
      
      
      
    } #end of cross_auswahl
          
          
          
          #mse_rf_df_2_coef_save<-unique(rf_df_2_coef_save$formel)
          
          
          
        
          
          
         
          #does cross-validation with model$formula and returns list with sorted mse's # was trained with only data_train not data_test --> mse on train_set
          
          cross_validation_for_mse_after_feature_selection <- function(df_x_coef_save){ #get formula column as object
            #df_x_coef_save<-rf_df_4_coef_save
            #formulas<-step_df_1_coef_save$formel
            formulas<-df_x_coef_save$formel
            e<- (formulas)
            
           # unique(df_x_coef_save$formel)
           # e<-mse_rf_df_2_coef_save
          
          
          df <- data.frame()
            for (i in 1:length(e)) {
              #i=2
              list_1 <- list()
              s<- paste("log_e.coli ~", e[i])
              
              
              for (j in 1:5) {
               # j = 1
                
                
                train_bacteria <- data_train[train_rows[[j]],]$log_e.coli
                train <- data_train[train_rows[[j]],] #without e.coli
                
                test_bacteria <- data_train[-c(train_rows[[j]]),]$log_e.coli
                test<-data_train[-c(train_rows[[j]]),]
                lm_1 <- lm(s, train)
                a<- prediction_and_mse(model1 = lm_1, test1 = test, test_bacteria1 = test_bacteria)
                list_1<-append(list_1,a)
                
                
              }
              mse_through_cross_validation<-mean(unlist(list_1))
              
              
              #list_2 <- append(list_2,assign(x = paste(deparse(substitute(e[i])),"formula",i,"mse_with_cross_selected_features",sep = "_"), mse_through_cross_validation))
              df <-rbind(df, mse_through_cross_validation)
              row.names(df)[i] <-paste(deparse(substitute(unique_formulas)),"formula",i, sep = "_")
              names(df)<-"mean_mse_cross"
              
            }
          df2<-df%>% arrange(mean_mse_cross)
          
          return(df2)
          }
          
          
          step_mse_cross_formula_1 <- cross_validation_for_mse_after_feature_selection(step_df_1_coef_save)
          step_mse_cross_formula_2 <- cross_validation_for_mse_after_feature_selection(step_df_2_coef_save)
          step_mse_cross_formula_3 <- cross_validation_for_mse_after_feature_selection(step_df_3_coef_save)
          step_mse_cross_formula_4 <- cross_validation_for_mse_after_feature_selection(step_df_4_coef_save)
          step_mse_cross_formula_5 <- cross_validation_for_mse_after_feature_selection(step_df_5_coef_save)
          
          rf_mse_cross_formula_1 <- cross_validation_for_mse_after_feature_selection(rf_df_1_coef_save)
          rf_mse_cross_formula_2 <- cross_validation_for_mse_after_feature_selection(rf_df_2_coef_save)
          rf_mse_cross_formula_3 <- cross_validation_for_mse_after_feature_selection(rf_df_3_coef_save)
          rf_mse_cross_formula_4 <- cross_validation_for_mse_after_feature_selection(rf_df_4_coef_save)
          rf_mse_cross_formula_5 <- cross_validation_for_mse_after_feature_selection(rf_df_5_coef_save)
          
          #get best formular from cross validation
          get_smallest_mse_and_formula <- function(df_x_coef_save,mse_cross_formula_df){
            #df_x_coef_save<-rf_df_3_coef_save
            #mse_cross_formula_df <-rf_mse_cross_formula_3
            #df_x_coef_save<-rf_df_1_coef_save
            #mse_cross_formula_df <-rf_mse_cross_formula_1
            #unique(df_x_coef_save$formel)
            
            name_splitted<-str_split(rownames(mse_cross_formula_df)[1], pattern = "_")[[1]]
            formula_number<-as.integer( name_splitted[length(name_splitted)])
            best_formula_and_mse_cross_validated <- cbind(df_x_coef_save[formula_number,ncol(df_x_coef_save)-1], (mse_cross_formula_df[1,]))
            best_formula_and_mse_cross_validated<-data.frame(best_formula_and_mse_cross_validated)
            row.names(best_formula_and_mse_cross_validated)<- deparse(substitute(df_x_coef_save))
            names(best_formula_and_mse_cross_validated)[1]<-"formel"
            names(best_formula_and_mse_cross_validated)[2]<-"mean_mse_cross"
            best_formula_and_mse_cross_validated$mean_mse_cross<-as.double(best_formula_and_mse_cross_validated$mean_mse_cross)
            return(best_formula_and_mse_cross_validated)
          }
          
          
          rf_smallest_mse_formula_coef_1<-get_smallest_mse_and_formula(rf_df_1_coef_save,rf_mse_cross_formula_1)
          rf_smallest_mse_formula_coef_2<-get_smallest_mse_and_formula(rf_df_2_coef_save,rf_mse_cross_formula_2)
          rf_smallest_mse_formula_coef_3<-get_smallest_mse_and_formula(rf_df_3_coef_save,rf_mse_cross_formula_3)
          rf_smallest_mse_formula_coef_4<-get_smallest_mse_and_formula(rf_df_4_coef_save,rf_mse_cross_formula_4)
          rf_smallest_mse_formula_coef_5<-get_smallest_mse_and_formula(rf_df_5_coef_save,rf_mse_cross_formula_5)
          
          
          step_smallest_mse_formula_coef_1<-get_smallest_mse_and_formula(step_df_1_coef_save,step_mse_cross_formula_1)
          step_smallest_mse_formula_coef_2<-get_smallest_mse_and_formula(step_df_2_coef_save,step_mse_cross_formula_2)
          step_smallest_mse_formula_coef_3<-get_smallest_mse_and_formula(step_df_3_coef_save,step_mse_cross_formula_3)
          step_smallest_mse_formula_coef_4<-get_smallest_mse_and_formula(step_df_4_coef_save,step_mse_cross_formula_4)
          step_smallest_mse_formula_coef_5<-get_smallest_mse_and_formula(step_df_5_coef_save,step_mse_cross_formula_5)
          
          #lasso
          #build dataframe for every  number of variables with lasso/step/ rf and their mean-mse-cross --> later used for testing on 
          fit_lasso_base_cross_stand <- cv.glmnet(train_sparse, data_train$log_e.coli,type.measure="mse", alpha=1, family="gaussian",  nfolds = 5,standardize = T,relax = F, foldid = foldid)#--> alpha =1:  lasso regressio
          fit_elnet_base_cross_stand <- cv.glmnet(train_sparse, data_train$log_e.coli,type.measure="mse", alpha=0.5, family="gaussian",  nfolds = 5,standardize = T,relax = F, foldid = foldid)#--> alpha =1:  lasso regressio
          
          #plot(fit_elnet_base_cross_stand)
          
          #small.lambda.index <- which(fit_lasso_base_cross_stand$lambda == cv$lambda.min)
          #small.lambda.betas <- cv$glmnet.fit$beta[, small.lambda.index]
          #beta_coef_nzero<-small.lambda.betas!=0
          #small.lambda.betas[beta_coef_nzero]
          #mse.min <- fit_lasso_base_cross_stand$cvm[small.lambda.index]
          
          #extract.coef(fit_lasso_base_cross_stand,  lambda =  "lambda.1se")
          #extract.coef(fit_lasso_base_cross_stand, lambda = "lambda.min")
          
          #coef(fit_lasso_base_cross_stand, )
          #search formulas for 5 coef
          #s_lasso_fits_5_coef<-fit_lasso_base_cross_stand$nzero==5
         
          
          #fit_lasso_base_cross_stand$glmnet.fit$dev.ratio
          
          get_formula_mse_and_lambda_from_cg.glmnet_fit<- function(lambdas_with_number_of_coeff, fit_glmnet){
            #lambdas_with_number_of_coeff<-lambdas_lasso_fits_3_coef
            #lambdas_with_number_of_coeff<-fit_elnet_base_cross_stand$lambda.min
            #fit_glmnet<-fit_elnet_base_cross_stand
            #fit_glmnet<-fit_lasso_base_cross_stand
            df<-data.frame()
            for (idx in 1:length(lambdas_with_number_of_coeff)) {
              #idx=1
            
            
              single_lambdas_with_number_of_coeff<-lambdas_with_number_of_coeff[idx] #lambda for first fit with 5 coef 
              
              
              lambda.index <- which(fit_glmnet$lambda == single_lambdas_with_number_of_coeff) # index of lambda for first fit with 5 coef 
              mse_fit <- fit_glmnet$cvm[lambda.index]  # mse for that index
              
              coefss<-fit_glmnet$glmnet.fit$beta[,lambda.index] # all coef for that fit
              indexs<-fit_glmnet$glmnet.fit$beta[,lambda.index]!=0 # index for coef =! 0
              
              non_zero_coef<-coefss[indexs] # coef =! of the fit
              coef_names_non_zero<-paste_together_step_coefficients(names(non_zero_coef))
              
             
              
              lasso_df_for_coef_number<-coef_names_non_zero
              lasso_df_for_coef_number<- as.data.frame(lasso_df_for_coef_number)
              lasso_df_for_coef_number<- cbind(lasso_df_for_coef_number,mse_fit, lambda.index,  single_lambdas_with_number_of_coeff)
              
              df<-rbind(df, lasso_df_for_coef_number)
              
            }
            return(df)
          }
          
          
          #s_lasso_fits_5_coef<-fit_lasso_base_cross_stand$nzero==5
          #lambdas_lasso_fits_5_coef<-fit_lasso_base_cross_stand$lambda[s_lasso_fits_5_coef]
          
          #search formulas for 2 coef
          s_lasso_fits_1_coef<-fit_lasso_base_cross_stand$nzero==1  
          lambdas_lasso_fits_1_coef<-fit_lasso_base_cross_stand$lambda[s_lasso_fits_1_coef]
          lasso_fits_1_formula_coef_mse <- get_formula_mse_and_lambda_from_cg.glmnet_fit(lambdas_lasso_fits_1_coef,fit_lasso_base_cross_stand) 
          
          #search formulas for 2 coef
          s_lasso_fits_2_coef<-fit_lasso_base_cross_stand$nzero==2  
          lambdas_lasso_fits_2_coef<-fit_lasso_base_cross_stand$lambda[s_lasso_fits_2_coef]
          lasso_fits_2_formula_coef_mse <- get_formula_mse_and_lambda_from_cg.glmnet_fit(lambdas_lasso_fits_2_coef,fit_lasso_base_cross_stand) 
          
          #search formulas for 3 coef
          s_lasso_fits_3_coef<-fit_lasso_base_cross_stand$nzero==3  
          lambdas_lasso_fits_3_coef<-fit_lasso_base_cross_stand$lambda[s_lasso_fits_3_coef]
          lasso_fits_3_formula_coef_mse <- get_formula_mse_and_lambda_from_cg.glmnet_fit(lambdas_lasso_fits_3_coef,fit_lasso_base_cross_stand)   
          #search formulas for 4 coef
          s_lasso_fits_4_coef<-fit_lasso_base_cross_stand$nzero==4  
          lambdas_lasso_fits_4_coef<-fit_lasso_base_cross_stand$lambda[s_lasso_fits_4_coef]
          lasso_fits_4_formula_coef_mse <- get_formula_mse_and_lambda_from_cg.glmnet_fit(lambdas_lasso_fits_4_coef,fit_lasso_base_cross_stand)          
          #search formulas for 5 coef
          s_lasso_fits_5_coef<-fit_lasso_base_cross_stand$nzero==5
          lambdas_lasso_fits_5_coef<-fit_lasso_base_cross_stand$lambda[s_lasso_fits_5_coef]
          lasso_fits_5_formula_coef_mse <- get_formula_mse_and_lambda_from_cg.glmnet_fit(lambdas_lasso_fits_5_coef,fit_lasso_base_cross_stand)
         
          
          #here are the proposed lambda.min and lambda.1se from cross validation 
          lasso_fits_lambda_min_formula_coef_mse <- get_formula_mse_and_lambda_from_cg.glmnet_fit(fit_lasso_base_cross_stand$lambda.min,fit_lasso_base_cross_stand)
          lasso_fits_lambda_1se_formula_coef_mse <- get_formula_mse_and_lambda_from_cg.glmnet_fit(fit_lasso_base_cross_stand$lambda.1se,fit_lasso_base_cross_stand)
          #here are the proposed lambda.min and lambda.1se from cross validation 
          elnet_fits_lambda_min_formula_coef_mse <- get_formula_mse_and_lambda_from_cg.glmnet_fit(fit_elnet_base_cross_stand$lambda.min, fit_elnet_base_cross_stand)
          elnet_fits_lambda_1se_formula_coef_mse <- get_formula_mse_and_lambda_from_cg.glmnet_fit(fit_elnet_base_cross_stand$lambda.1se, fit_elnet_base_cross_stand)
          
          #small.lambda.betas <- cv$glmnet.fit$beta[, small.lambda.index]
          #beta_coef_nzero<-small.lambda.betas!=0
          #small.lambda.betas[beta_coef_nzero]
          #mse.min <- fit_lasso_base_cross_stand$cvm[small.lambda.index]
          
          
          
          
          #get unique formulas
          unique_step_formulas_coef_1<-unique(step_df_1_coef_save$formel)
          unique_step_formulas_coef_2<-unique(step_df_2_coef_save$formel)
          unique_step_formulas_coef_3<-unique(step_df_3_coef_save$formel)
          unique_step_formulas_coef_4<-unique(step_df_4_coef_save$formel)
          unique_step_formulas_coef_5<-unique(step_df_5_coef_save$formel)
          
          unique_rf_formulas_coef_1<-unique(rf_df_1_coef_save$formel)
          unique_rf_formulas_coef_2<-unique(rf_df_2_coef_save$formel)
          unique_rf_formulas_coef_3<-unique(rf_df_3_coef_save$formel)
          unique_rf_formulas_coef_4<-unique(rf_df_4_coef_save$formel)
          unique_rf_formulas_coef_5<-unique(rf_df_5_coef_save$formel)
          
          unique_lasso_formulas_coef_1<-unique(lasso_fits_1_formula_coef_mse$lasso_df_for_coef_number)
          unique_lasso_formulas_coef_2<-unique(lasso_fits_2_formula_coef_mse$lasso_df_for_coef_number)
          unique_lasso_formulas_coef_3<-unique(lasso_fits_3_formula_coef_mse$lasso_df_for_coef_number)
          unique_lasso_formulas_coef_4<-unique(lasso_fits_4_formula_coef_mse$lasso_df_for_coef_number)
          unique_lasso_formulas_coef_5<-unique(lasso_fits_5_formula_coef_mse$lasso_df_for_coef_number)
          #unique 1se and lambda_min formulas
          unique_lasso_formulas_coef_lambda_min <-unique(lasso_fits_lambda_min_formula_coef_mse$lasso_df_for_coef_number)
          unique_lasso_formulas_coef_lambda_1se <-unique(lasso_fits_lambda_1se_formula_coef_mse$lasso_df_for_coef_number)
          
          
          #unique 1se and lambda_min formulas
          unique_elnet_formulas_coef_lambda_min <-unique(elnet_fits_lambda_min_formula_coef_mse$lasso_df_for_coef_number)
          unique_elnet_formulas_coef_lambda_1se <-unique(elnet_fits_lambda_1se_formula_coef_mse$lasso_df_for_coef_number)
          
          
          lasso_df_1_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
          lasso_df_2_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
          lasso_df_3_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
          lasso_df_4_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
          lasso_df_5_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
          
          lasso_df_lambda_min_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
          lasso_df_lambda_1se_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
          
         
          elnet_df_lambda_min_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
          elnet_df_lambda_1se_coef<-build_rename_cols_to_variable_names(df_with_all_variable_names)
          
         
          #runterbrechen von formula auf features 
          remove_zero_cols_lasso<-function(df){
            
            return(df[, colSums(df != 0) > 0])
          }
          
          
          
          get_occurences_glmnet_feature_selection<-function(df_x_coef,unique_glmnet_formulas_coef_x){
            #df_x_coef<-lasso_df_5_coef
            #unique_glmnet_formulas_coef_x<- unique_lasso_formulas_coef_5
            
            for (idx in 1: length(unique_glmnet_formulas_coef_x)) {
              new_row_glmnet_df_x_coef<-get_new_iteration_row(df_x_coef,unique_glmnet_formulas_coef_x[idx])
              df_x_coef<-rbind(df_x_coef,new_row_glmnet_df_x_coef)
            }
            u<-df_x_coef[-1,] %>% select_if(~ !is.numeric(.) || sum(.) != 0)
            return(u)
          }
          
          
          #build occurance df
          lasso_df_1_coef<-get_occurences_glmnet_feature_selection(lasso_df_1_coef, unique_lasso_formulas_coef_1)
          lasso_df_2_coef<-get_occurences_glmnet_feature_selection(lasso_df_2_coef, unique_lasso_formulas_coef_2)
          lasso_df_3_coef<-get_occurences_glmnet_feature_selection(lasso_df_3_coef, unique_lasso_formulas_coef_3)
          lasso_df_4_coef<-get_occurences_glmnet_feature_selection(lasso_df_4_coef, unique_lasso_formulas_coef_4)
          lasso_df_5_coef<-get_occurences_glmnet_feature_selection(lasso_df_5_coef, unique_lasso_formulas_coef_5)
          
          lasso_df_lambda_min_coef<-get_occurences_glmnet_feature_selection(lasso_df_lambda_min_coef, unique_lasso_formulas_coef_lambda_min)
          lasso_df_lambda_1se_coef<-get_occurences_glmnet_feature_selection(lasso_df_lambda_1se_coef, unique_lasso_formulas_coef_lambda_1se)
          
          elnet_df_lambda_min_coef<-get_occurences_glmnet_feature_selection(elnet_df_lambda_min_coef, unique_elnet_formulas_coef_lambda_min)
          elnet_df_lambda_1se_coef<-get_occurences_glmnet_feature_selection(elnet_df_lambda_1se_coef, unique_elnet_formulas_coef_lambda_1se)
          
          
          
          
          calc_col_means_glmnet <- function(df_x_coef_save){
            #df_x_coef_save<-lasso_df_5_coef
            #df_x_coef_save<-lasso_smallest_mse_formula_coef_1
            new_df <- as.data.frame(colMeans(df_x_coef_save[-c((ncol(df_x_coef_save)-1):ncol(df_x_coef_save))]))
            new_df <- new_df %>% t()
            
            #new_df <- cbind(new_df,colMeans(df_x_coef_save$mse))
            #colnames(new_df)[ncol(new_df)] <- "MSE"
            
            #new_df <- cbind(new_df,mean(df_x_coef_save$n_features))
            #colnames(new_df)[ncol(new_df)] <- "n_features"
            
            
            new_rowname<-deparse(substitute(df_x_coef_save))
            rownames(new_df)<-deparse(substitute(df_x_coef_save))
            new_df<- as.data.frame(new_df)
            
            return(new_df)
          }
          
          #colMeans(lasso_df_5_coef[-c(ncol(lasso_df_5_coef)-1,ncol(lasso_df_5_coef))])
          
          #calc_col_means(rf_df_5_coef_save)
          #rf_df_2_coef_save
          calc_col_means <- function(df_x_coef_save){
            #df_x_coef_save<-step_df_1_coef_save
            new_df <- as.data.frame(colMeans(df_x_coef_save[-c((ncol(df_x_coef_save)-4):ncol(df_x_coef_save))]))
            new_df <- new_df %>% t()
            
            new_df <- cbind(new_df,colMeans(df_x_coef_save$mse))
            colnames(new_df)[ncol(new_df)] <- "MSE"
            
            new_df <- cbind(new_df,mean(df_x_coef_save$n_features))
            colnames(new_df)[ncol(new_df)] <- "n_features"
            
            
            new_rowname<-deparse(substitute(df_x_coef_save))
            rownames(new_df)<-deparse(substitute(df_x_coef_save))
            new_df<- as.data.frame(new_df)
            
            return(new_df)
          }
          
          
          get_most_selected_formulas_and_occurences<-function(fits_x_formula_coef_mse){
            #fits_x_formula_coef_mse<-lasso_fits_5_formula_coef_mse
            unique_formulas <- unique(fits_x_formula_coef_mse$lasso_df_for_coef_number)
            dfol<- data.frame()
            idxj<-1
            for (entry in unique_formulas) {
              
              dfol[idxj,1]<-entry
              dfol[idxj,2]<-sum(fits_x_formula_coef_mse$lasso_df_for_coef_number==entry)/length(fits_x_formula_coef_mse$lasso_df_for_coef_number)
              idxj<-idxj+1
              
            }
            names(dfol)[1]<- "formel"
            names(dfol)[2]<- "occurence"
            return(dfol)
          }
          
          #most selected features searched on train/test split
          lasso_mse_min_selected_features_1<-get_most_selected_formulas_and_occurences(lasso_fits_1_formula_coef_mse)
          lasso_mse_min_selected_features_2<-get_most_selected_formulas_and_occurences(lasso_fits_2_formula_coef_mse)
          lasso_mse_min_selected_features_3<-get_most_selected_formulas_and_occurences(lasso_fits_3_formula_coef_mse)
          lasso_mse_min_selected_features_4<-get_most_selected_formulas_and_occurences(lasso_fits_4_formula_coef_mse)
          lasso_mse_min_selected_features_5<-get_most_selected_formulas_and_occurences(lasso_fits_5_formula_coef_mse)
          
          
          lasso_mse_min_selected_features_lambda_min<-get_most_selected_formulas_and_occurences(lasso_fits_lambda_min_formula_coef_mse)
          lasso_mse_min_selected_features_lambda_1se<-get_most_selected_formulas_and_occurences(lasso_fits_lambda_1se_formula_coef_mse)
          
          
          elnet_mse_min_selected_features_lambda_min<-get_most_selected_formulas_and_occurences(elnet_fits_lambda_min_formula_coef_mse)
          elnet_mse_min_selected_features_lambda_1se<-get_most_selected_formulas_and_occurences(elnet_fits_lambda_1se_formula_coef_mse)
          
          #cross validate with linear model to get mse on cross
          
          get_glmnet_features_with_mse_min <- function(glmnet_most_selected_features_x){
            
            #glmnet_most_selected_features_x<-lasso_mse_min_selected_features_1
            mse_df <-data.frame()
            for (idx in 1:length(glmnet_most_selected_features_x$formel)) {
              #idx<-1
              mse_fit<-cross_validation_for_mse_after_feature_selection(glmnet_most_selected_features_x[idx,])
              new_row <- cbind(glmnet_most_selected_features_x$formel[idx],mse_fit)
              row.names(new_row) <-  deparse(substitute(glmnet_most_selected_features_x))
              mse_df<-rbind(mse_df, new_row)
            }
            mse_df <- mse_df%>% arrange(mean_mse_cross)
            names(mse_df)[1]<- "formel"
            
            return(mse_df[1,])
            
          }
          
          
          #here ist formula with mse in test/train for lambda
          lasso_smallest_mse_formula_coef_1<-get_glmnet_features_with_mse_min(lasso_mse_min_selected_features_1)
          lasso_smallest_mse_formula_coef_2<-get_glmnet_features_with_mse_min(lasso_mse_min_selected_features_2)
          lasso_smallest_mse_formula_coef_3<-get_glmnet_features_with_mse_min(lasso_mse_min_selected_features_3)
          lasso_smallest_mse_formula_coef_4<-get_glmnet_features_with_mse_min(lasso_mse_min_selected_features_4)
          lasso_smallest_mse_formula_coef_5<-get_glmnet_features_with_mse_min(lasso_mse_min_selected_features_5)
          
          #interpretation ab hier
          algorithms_mse_features_1<-rbind(lasso_smallest_mse_formula_coef_1,step_smallest_mse_formula_coef_1,rf_smallest_mse_formula_coef_1)%>%arrange(mean_mse_cross)
          algorithms_mse_features_2<-rbind(lasso_smallest_mse_formula_coef_2,step_smallest_mse_formula_coef_2,rf_smallest_mse_formula_coef_2)%>%arrange(mean_mse_cross)
          algorithms_mse_features_3<-rbind(lasso_smallest_mse_formula_coef_3,step_smallest_mse_formula_coef_3,rf_smallest_mse_formula_coef_3)%>%arrange(mean_mse_cross)
          algorithms_mse_features_4<-rbind(lasso_smallest_mse_formula_coef_4,step_smallest_mse_formula_coef_4,rf_smallest_mse_formula_coef_4)%>%arrange(mean_mse_cross)
          algorithms_mse_features_5<-rbind(lasso_smallest_mse_formula_coef_5,step_smallest_mse_formula_coef_5,rf_smallest_mse_formula_coef_5)%>%arrange(mean_mse_cross)
          
          
          
          full_join(lasso_smallest_mse_formula_coef_1,step_smallest_mse_formula_coef_1)
          full_join(lasso_smallest_mse_formula_coef_2,step_smallest_mse_formula_coef_2)
          
          
          
          typeof(lasso_smallest_mse_formula_coef_1$mean_mse_cross)
          typeof(step_smallest_mse_formula_coef_5$mean_mse_cross)
          
          
          
          
          
          
          
          
          
          
            #small.lambda.index <- which(fit_lasso_base_cross_stand$lambda == cv$lambda.min)
            #small.lambda.betas <- fit_lasso_base_cross_stand$glmnet.fit$beta[, small.lambda.index]
          
            #lambda.index <- which(fit_lasso_base_cross_stand$lambda == fit_lasso_base_cross_stand$lambda.min)
            #lambda.betas <- fit_lasso_base_cross_stand$glmnet.fit$beta[, lambda.index]
            
            
          
          mse_step_1_fold<-(unlist(mse_list_step_1, recursive=FALSE))
          mse_step_2_fold<-(unlist(mse_list_step_2, recursive=FALSE))
          mse_step_3_fold<-(unlist(mse_list_step_3, recursive=FALSE))
          mse_step_4_fold<-(unlist(mse_list_step_4, recursive=FALSE))
          mse_step_5_fold<-(unlist(mse_list_step_5, recursive=FALSE))
          
          r2_step_1_fold<-(unlist(r2_list_step_1, recursive=FALSE))
          r2_step_2_fold<-(unlist(r2_list_step_2, recursive=FALSE))
          r2_step_3_fold<-(unlist(r2_list_step_3, recursive=FALSE))
          r2_step_4_fold<-(unlist(r2_list_step_4, recursive=FALSE))
          r2_step_5_fold<-(unlist(r2_list_step_5, recursive=FALSE))
          
          
          step_df_1_coef_save$mse <- as.data.frame(mse_step_1_fold)
          step_df_2_coef_save$mse <- as.data.frame(mse_step_2_fold)
          step_df_3_coef_save$mse <- as.data.frame(mse_step_3_fold)
          step_df_4_coef_save$mse <- as.data.frame(mse_step_4_fold)
          step_df_5_coef_save$mse <- as.data.frame(mse_step_5_fold)
          
          
          step_df_1_coef_save<-calc_n_features(step_df_1_coef_save)
          step_df_2_coef_save<-calc_n_features(step_df_2_coef_save)
          step_df_3_coef_save<-calc_n_features(step_df_3_coef_save)
          step_df_4_coef_save<-calc_n_features(step_df_4_coef_save)
          step_df_5_coef_save<-calc_n_features(step_df_5_coef_save)
          
          step_df_1_coef_save$r2 <- as.data.frame(r2_step_1_fold)
          step_df_2_coef_save$r2 <- as.data.frame(r2_step_2_fold)
          step_df_3_coef_save$r2 <- as.data.frame(r2_step_3_fold)
          step_df_4_coef_save$r2 <- as.data.frame(r2_step_4_fold)
          step_df_5_coef_save$r2 <- as.data.frame(r2_step_5_fold)
          
          
          mse_rf_1_fold<-  unlist(mse_list_rf_1, recursive=FALSE)
          mse_rf_2_fold<-  unlist(mse_list_rf_2, recursive=FALSE)
          mse_rf_3_fold<-  unlist(mse_list_rf_3, recursive=FALSE)
          mse_rf_4_fold<-  unlist(mse_list_rf_4, recursive=FALSE)
          mse_rf_5_fold<-  unlist(mse_list_rf_5, recursive=FALSE)
          
          r2_rf_1_fold<-  unlist(r2_list_rf_1, recursive=FALSE)
          r2_rf_2_fold<-  unlist(r2_list_rf_2, recursive=FALSE)
          r2_rf_3_fold<-  unlist(r2_list_rf_3, recursive=FALSE)
          r2_rf_4_fold<-  unlist(r2_list_rf_4, recursive=FALSE)
          r2_rf_5_fold<-  unlist(r2_list_rf_5, recursive=FALSE)
          
          
          
          rf_df_1_coef_save$mse <- as.data.frame(mse_rf_1_fold)
          rf_df_2_coef_save$mse <- as.data.frame(mse_rf_2_fold)
          rf_df_3_coef_save$mse <- as.data.frame(mse_rf_3_fold)
          rf_df_4_coef_save$mse <- as.data.frame(mse_rf_4_fold)
          rf_df_5_coef_save$mse <- as.data.frame(mse_rf_5_fold)
          
          
          
          rf_df_1_coef_save<-calc_n_features(rf_df_1_coef_save)
          rf_df_2_coef_save<-calc_n_features(rf_df_2_coef_save)
          rf_df_3_coef_save<-calc_n_features(rf_df_3_coef_save)
          rf_df_4_coef_save<-calc_n_features(rf_df_4_coef_save)
          rf_df_5_coef_save<-calc_n_features(rf_df_5_coef_save)
          
          rf_df_1_coef_save$r2 <- as.data.frame(r2_rf_1_fold)
          rf_df_2_coef_save$r2 <- as.data.frame(r2_rf_2_fold)
          rf_df_3_coef_save$r2 <- as.data.frame(r2_rf_3_fold)
          rf_df_4_coef_save$r2 <- as.data.frame(r2_rf_4_fold)
          rf_df_5_coef_save$r2 <- as.data.frame(r2_rf_5_fold)
          
          
          
          
          # do cross validation - to get cross validated mse
          lasso_mse_cross_formula_1 <- cross_validation_for_mse_after_feature_selection(lasso_df_1_coef)
          lasso_smallest_mse_formula_coef_1<-get_smallest_mse_and_formula(lasso_df_1_coef,lasso_mse_cross_formula_1)
          
          #this is for the best lasso_df_feature
          cross_validation_for_mse_after_feature_selection (lasso_df_1_coef)
          cross_validation_for_mse_after_feature_selection (lasso_df_2_coef)
          
          add_empty_na_mse_col_to_lasso <- function(df){
            df$MSE <- NA
            df$n_features <- ncol(df)-3
            return(df)
          }
          
          lasso_df_1_coef_save <-add_empty_na_mse_col_to_lasso(lasso_df_1_coef)
          lasso_df_2_coef_save <-add_empty_na_mse_col_to_lasso(lasso_df_2_coef)
          lasso_df_3_coef_save <-add_empty_na_mse_col_to_lasso(lasso_df_3_coef)
          lasso_df_4_coef_save <-add_empty_na_mse_col_to_lasso(lasso_df_4_coef)
          lasso_df_5_coef_save <-add_empty_na_mse_col_to_lasso(lasso_df_5_coef)
          
          lasso_df_lambda_min_coef_save <-add_empty_na_mse_col_to_lasso(lasso_df_lambda_min_coef)
          lasso_df_lambda_1se_coef_save <-add_empty_na_mse_col_to_lasso(lasso_df_lambda_1se_coef)
          
          elnet_df_lambda_min_coef_save <-add_empty_na_mse_col_to_lasso(elnet_df_lambda_min_coef)
          elnet_df_lambda_1se_coef_save <-add_empty_na_mse_col_to_lasso(elnet_df_lambda_1se_coef)
          #mit elnet wurden xxx algorithmen ausgewhlt
          
          
          lasso_lambda_min_selected_features_in_different_train_test_splits<- lasso_df_lambda_min_coef_save
          lasso_lambda_1se_selected_features_in_different_train_test_splits<- lasso_df_lambda_1se_coef_save
          
          elnet_lambda_min_selected_features_in_different_train_test_splits<- elnet_df_lambda_min_coef_save
          elnet_lambda_1se_selected_features_in_different_train_test_splits<- elnet_df_lambda_1se_coef_save
          
          
          
          lasso_1_selected_features_in_different_train_test_splits<- lasso_df_1_coef_save
          step_1_selected_features_in_different_train_test_splits <- calc_col_means(step_df_1_coef_save)
          rf_1_selected_features_in_different_train_test_splits <- calc_col_means(rf_df_1_coef_save)
          
          lasso_2_selected_features_in_different_train_test_splits<- lasso_df_2_coef_save
          step_2_selected_features_in_different_train_test_splits <- calc_col_means(step_df_2_coef_save)
          rf_2_selected_features_in_different_train_test_splits <- calc_col_means(rf_df_2_coef_save)
          
          lasso_3_selected_features_in_different_train_test_splits<- lasso_df_3_coef_save
          step_3_selected_features_in_different_train_test_splits <- calc_col_means(step_df_3_coef_save)
          rf_3_selected_features_in_different_train_test_splits <- calc_col_means(rf_df_3_coef_save)
          
          lasso_4_selected_features_in_different_train_test_splits<- lasso_df_4_coef_save
          step_4_selected_features_in_different_train_test_splits <- calc_col_means(step_df_4_coef_save)
          rf_4_selected_features_in_different_train_test_splits <- calc_col_means(rf_df_4_coef_save)
          
          lasso_5_selected_features_in_different_train_test_splits<- lasso_df_5_coef_save
          step_5_selected_features_in_different_train_test_splits <- calc_col_means(step_df_5_coef_save)
          rf_5_selected_features_in_different_train_test_splits <- calc_col_means(rf_df_5_coef_save)
          
          
          combine_occurence_table <-function(step_x_selected_features_in_different_train_test_splits,rf_x_selected_features_in_different_train_test_splits,lasso_x_selected_features_in_different_train_test_splits){
            #step_x_selected_features_in_different_train_test_splits <-step_4_selected_features_in_different_train_test_splits 
            #rf_x_selected_features_in_different_train_test_splits<-rf_4_selected_features_in_different_train_test_splits
            #lasso_x_selected_features_in_different_train_test_splits<-lasso_4_selected_features_in_different_train_test_splits
            rownames(step_x_selected_features_in_different_train_test_splits)[1]<- "step"
            rownames(rf_x_selected_features_in_different_train_test_splits)[1]<- "rf"
            rownames(lasso_x_selected_features_in_different_train_test_splits)[1]<- "lasso"
            
            
            #occurence_feature<-full_join(x = step_x_selected_features_in_different_train_test_splits, y = rf_x_selected_features_in_different_train_test_splits, )%>% full_join(lasso_x_selected_features_in_different_train_test_splits)
            occurence_feature<- bind_rows(step_x_selected_features_in_different_train_test_splits, rf_x_selected_features_in_different_train_test_splits, lasso_x_selected_features_in_different_train_test_splits)
            cols<- c("MSE", "n_features", "split_id", "formel")
            occurence_feature<- occurence_feature%>% select(-one_of(cols))
            
            #occurence_feature<- occurence_feature[,-c((ncol(occurence_feature)-4):ncol(occurence_feature))]
            return(occurence_feature)
          }
         
          #occurence table interpretation
           occurence_feature_1<-combine_occurence_table(step_1_selected_features_in_different_train_test_splits,rf_1_selected_features_in_different_train_test_splits,lasso_1_selected_features_in_different_train_test_splits)
           occurence_feature_2<-combine_occurence_table(step_2_selected_features_in_different_train_test_splits,rf_2_selected_features_in_different_train_test_splits,lasso_2_selected_features_in_different_train_test_splits)
           occurence_feature_3<-combine_occurence_table(step_3_selected_features_in_different_train_test_splits,rf_3_selected_features_in_different_train_test_splits,lasso_3_selected_features_in_different_train_test_splits)
           occurence_feature_4<-combine_occurence_table(step_4_selected_features_in_different_train_test_splits,rf_4_selected_features_in_different_train_test_splits,lasso_4_selected_features_in_different_train_test_splits)
           occurence_feature_5<-combine_occurence_table(step_5_selected_features_in_different_train_test_splits,rf_5_selected_features_in_different_train_test_splits,lasso_5_selected_features_in_different_train_test_splits)
          
           cols<- c("MSE", "n_features", "split_id", "formel")
           occurence_feature_lasso_1se<- lasso_lambda_1se_selected_features_in_different_train_test_splits%>% select(-one_of(cols))
           occurence_feature_lasso_min<- lasso_lambda_min_selected_features_in_different_train_test_splits%>% select(-one_of(cols))
           
           
           combine_with_formula_column<-function(occurence, unique_step_features=0, unique_rf_features, unique_lasso_features){
             #occurence <-occurence_feature_4
             #unique_step_features <- unique_step_formulas_coef_4
            # unique_rf_features <- unique_rf_formulas_coef_4
             #unique_lasso_features<- unique_lasso_formulas_coef_4
             if (unique_step_features==0) {
               df<- occurence
               #step_features<-character() 
               #rf_features<-character() 
               lasso_features<-character() 
               idx<- 1
               #for (entry in unique_step_features) {
                 
                # step_features<-paste(step_features,entry, sep = paste("  formula", idx,": ", sep = "_"))
                # idx<- idx+1
                 
                 
               #}
               
               #idx<- 1
               #for (entry in unique_rf_features) {
                 
                # rf_features<-paste(rf_features,entry, sep = paste("  formula", idx,": ", sep = "_"))
                 #idx<- idx+1
                 
                 
               #}
               
               idx<- 1
               for (entry in unique_lasso_features) {
                 
                 lasso_features<-paste(lasso_features,entry, sep = paste("  formula", idx,": ", sep = "_"))
                 idx<- idx+1
                 
                 
               }
               
               #new_column_df <- c(length(unique_step_features),length(unique_rf_features),length(unique_lasso_features))
               new_column_df <- c(length(unique_lasso_features))
               new_column_df2<- c(lasso_features)
               df<- cbind(df,new_column_df,new_column_df2)
               colnames(df)[ncol(df)-1]<- "n_formulas"
               colnames(df)[ncol(df)]<- "found_formulas"
               
             }
             else {
             
             
             
            df<- occurence
            step_features<-character() 
            rf_features<-character() 
            lasso_features<-character() 
            idx<- 1
           for (entry in unique_step_features) {
             
             step_features<-paste(step_features,entry, sep = paste("  formula", idx,": ", sep = "_"))
             idx<- idx+1
             
             
           }
           
           idx<- 1
           for (entry in unique_rf_features) {
             
             rf_features<-paste(rf_features,entry, sep = paste("  formula", idx,": ", sep = "_"))
             idx<- idx+1
             
             
           }
           
           idx<- 1
           for (entry in unique_lasso_features) {
             
             lasso_features<-paste(lasso_features,entry, sep = paste("  formula", idx,": ", sep = "_"))
             idx<- idx+1
             
             
           }
           
           new_column_df <- c(length(unique_step_features),length(unique_rf_features),length(unique_lasso_features))
           new_column_df2<- c(step_features,rf_features,lasso_features)
           df<- cbind(df,new_column_df,new_column_df2)
           colnames(df)[ncol(df)-1]<- "n_formulas"
           colnames(df)[ncol(df)]<- "found_formulas"
             }
           return(df) 
           }
           
          
           
          
           
           occurence_feature_1_analysis <- combine_with_formula_column(occurence_feature_1,unique_step_formulas_coef_1, unique_rf_formulas_coef_1,unique_lasso_formulas_coef_1)
           occurence_feature_2_analysis <- combine_with_formula_column(occurence_feature_2,unique_step_formulas_coef_2, unique_rf_formulas_coef_2,unique_lasso_formulas_coef_2)
           occurence_feature_3_analysis <- combine_with_formula_column(occurence_feature_3,unique_step_formulas_coef_3, unique_rf_formulas_coef_3,unique_lasso_formulas_coef_3)
           occurence_feature_4_analysis <- combine_with_formula_column(occurence_feature_4,unique_step_formulas_coef_4, unique_rf_formulas_coef_4,unique_lasso_formulas_coef_4)
           occurence_feature_5_analysis <- combine_with_formula_column(occurence_feature_5,unique_step_formulas_coef_5, unique_rf_formulas_coef_5,unique_lasso_formulas_coef_5)
           
           occurence_feature_lasso_1se_analysis <-  combine_with_formula_column(occurence_feature_lasso_1se, unique_step_features = 0,unique_rf_features = 0,unique_lasso_features = unique_lasso_formulas_coef_lambda_1se)
           occurence_feature_lasso_min_analysis <-  combine_with_formula_column(occurence_feature_lasso_min, unique_step_features = 0,unique_rf_features = 0,unique_lasso_features = unique_lasso_formulas_coef_lambda_min)
           
          
           unique_rf_formulas_coef_1
           
           calc_mse_for_unique_formulas_with_test_set<-function(unique_step_formulas,unique_rf_formulas,unique_lasso_formulas){
              #unique_step_formulas<-unique_rf_formulas_coef_3
              #unique_rf_formulas<-unique_step_formulas_coef_3
              #unique_lasso_formulas<-unique_lasso_formulas_coef_3
             if (unique_step_formulas==0) {
               list_unqiue_formulas_all_algorithms<-unique(unlist(list(unique_lasso_formulas)))
             } 
             else
             {
             list_unqiue_formulas_all_algorithms<-unique(unlist(list(unique_rf_formulas,unique_step_formulas,unique_lasso_formulas)))
             }
             mse<-data.frame()
             idx<- 1
             for (entry in list_unqiue_formulas_all_algorithms) {
               #entry<-list_unqiue_formulas_all_algorithms[1]
               formel<-paste("log_e.coli ~ ",entry)
               
               model<- lm(formel, data_train)
               mse_iteration<-prediction_and_mse(model1 = model, test_bacteria1 = data_test$log_e.coli, test1 = data_test)
               mse[idx,1] <-mse_iteration
               idx<- idx+1
               
             }
              #order_index<-order(mse$V1)[1]
              df<-data.frame(list_unqiue_formulas_all_algorithms , mse)
              #order_index<-order(mse$V1)[1]
              #df<-data.frame(list_unqiue_formulas_all_algorithms[order_index] , mse[order_index,])
              
              names(df)[1]<- "formula_with_lowest_mse_on_test"
              names(df)[2]<- "mse"
              return(df)
                
           }           
           
           formula_mse_on_test_coef_1<-calc_mse_for_unique_formulas_with_test_set(unique_step_formulas_coef_1,unique_rf_formulas_coef_1,unique_lasso_formulas_coef_1 )%>% arrange(mse)
           formula_mse_on_test_coef_2<-calc_mse_for_unique_formulas_with_test_set(unique_step_formulas_coef_2,unique_rf_formulas_coef_2,unique_lasso_formulas_coef_2 )%>% arrange(mse)
           formula_mse_on_test_coef_3<-calc_mse_for_unique_formulas_with_test_set(unique_step_formulas_coef_3,unique_rf_formulas_coef_3,unique_lasso_formulas_coef_3)%>% arrange(mse)
           formula_mse_on_test_coef_4<-calc_mse_for_unique_formulas_with_test_set(unique_step_formulas_coef_4,unique_rf_formulas_coef_4,unique_lasso_formulas_coef_4) %>%arrange(mse)
           formula_mse_on_test_coef_5<-calc_mse_for_unique_formulas_with_test_set(unique_step_formulas_coef_5,unique_rf_formulas_coef_5,unique_lasso_formulas_coef_5) %>%arrange(mse)
           
           
           formula_mse_on_test_coef_lambda_min<-calc_mse_for_unique_formulas_with_test_set(unique_step_formulas = 0,unique_rf_formulas = 0,unique_lasso_formulas = unique_lasso_formulas_coef_lambda_min) %>%arrange(mse)
           formula_mse_on_test_coef_lambda_1se<-calc_mse_for_unique_formulas_with_test_set(unique_step_formulas = 0,unique_rf_formulas = 0,unique_lasso_formulas = unique_lasso_formulas_coef_lambda_1se) %>%arrange(mse)
           
           
           ssss<-rbind(formula_mse_on_test_coef_1,formula_mse_on_test_coef_2,formula_mse_on_test_coef_3,formula_mse_on_test_coef_4,formula_mse_on_test_coef_5,formula_mse_on_test_coef_lambda_min,formula_mse_on_test_coef_lambda_1se)
           
           ssss%>% arrange(mse)
           
           best_formula_with_coef_1<- formula_mse_on_test_coef_1[1,]
           best_formula_with_coef_2<- formula_mse_on_test_coef_2[1,]
           best_formula_with_coef_3<- formula_mse_on_test_coef_3[1,]
           best_formula_with_coef_4<- formula_mse_on_test_coef_4[1,]
           best_formula_with_coef_5<- formula_mse_on_test_coef_5[1,]
           
           
           
            
           
           check_if_algorithm_found_best_formula <- function(best_formula,occurence){
             #best_formula<-best_formula_with_coef_2
             #occurence <- occurence_feature_2_analysis
             occurence$found_best_formula<-F
             occurence$mse_best_formula<-list(best_formula$formula_with_lowest_mse_on_test,best_formula$formula_with_lowest_mse_on_test,best_formula$formula_with_lowest_mse_on_test)
              for (rows in 1:nrow(occurence)) {
             #rows<-2
                 if (grepl(best_formula$formula_with_lowest_mse_on_test, occurence$found_formulas[rows], fixed = TRUE)) {
                 occurence$found_best_formula[rows] <- T
               }else{
                 occurence$found_best_formula[rows] <- F
               }
             }
             return(occurence)
           }
           
           occurence_feature_1_analysis<-check_if_algorithm_found_best_formula(best_formula_with_coef_1,occurence_feature_1_analysis)
           occurence_feature_2_analysis<-check_if_algorithm_found_best_formula(best_formula_with_coef_2,occurence_feature_2_analysis)
           occurence_feature_3_analysis<-check_if_algorithm_found_best_formula(best_formula_with_coef_3,occurence_feature_3_analysis)
           occurence_feature_4_analysis<-check_if_algorithm_found_best_formula(best_formula_with_coef_4,occurence_feature_4_analysis)
           occurence_feature_5_analysis<-check_if_algorithm_found_best_formula(best_formula_with_coef_5,occurence_feature_5_analysis)
           
           
           #unique formiulas for every algorithm
           unique_step_formulas<-unique(unlist(list(unique_step_formulas_coef_1,unique_step_formulas_coef_2,unique_step_formulas_coef_3,unique_step_formulas_coef_4,unique_step_formulas_coef_5)))
           unique_rf_formulas<-unique(unlist(list(unique_rf_formulas_coef_1,unique_rf_formulas_coef_2,unique_rf_formulas_coef_3,unique_rf_formulas_coef_4,unique_rf_formulas_coef_5)))
           
           #added lambda_1se not lambda_min because to much features selected
           unique_lasso_formulas<-unique(unlist(list(unique_lasso_formulas_coef_1,unique_lasso_formulas_coef_2,unique_lasso_formulas_coef_3,unique_lasso_formulas_coef_4,unique_lasso_formulas_coef_5, unique_lasso_formulas_coef_lambda_1se,unique_lasso_formulas_coef_lambda_min)))
           unique_elnet_formulas<-unique(unlist(list(unique_elnet_formulas_coef_lambda_1se,unique_elnet_formulas_coef_lambda_min)))
           
           
           #only done for coef 5 formulas --> add new level for every coef_x: stat_model_tests
           #unique_step_formulas<-unique_rf_formulas_coef_5
           #unique_rf_formulas<-unique_step_formulas_coef_5
           #unique_lasso_formulas<-unique_lasso_formulas_coef_5
           
           
            list_formulas_all_algorithms<-list(unique(unlist(list(unique_rf_formulas,unique_step_formulas,unique_lasso_formulas, unique_elnet_formulas))))
           
           
            df_all_algorithms_with_mse_on_test<-calc_mse_for_unique_formulas_with_test_set(unique_step_formulas = 0,unique_rf_formulas = 0,unique_lasso_formulas = list_formulas_all_algorithms) %>%arrange(mse)
           
            df_all_algorithms_with_mse_on_test$step <-F
            df_all_algorithms_with_mse_on_test$rf <-F
            df_all_algorithms_with_mse_on_test$lasso <-F
            df_all_algorithms_with_mse_on_test$elnet <-F
           
            #df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test[1] == unique_rf_formulas[7]
            
            
          ##check if rf _found_formula  
          for (jdx in 1:length(unique_rf_formulas)) {
           for (idx in 1:nrow(df_all_algorithms_with_mse_on_test)) {
             #idx<-1
             if (df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test[idx]== unique_rf_formulas[jdx]) {
               df_all_algorithms_with_mse_on_test$rf[idx]<- T
             
               
             }
             
             
           }
            
          }  
            #check if lasso _found_formula  
          for (jdx in 1:length(unique_lasso_formulas)) {
              for (idx in 1:nrow(df_all_algorithms_with_mse_on_test)) {
                #idx<-1
                if (df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test[idx]== unique_lasso_formulas[jdx]) {
                  df_all_algorithms_with_mse_on_test$lasso[idx]<- T
                  
                  
                }
                
                
              }
              
          }   
            #check if step _found_formula  
          for (jdx in 1:length(unique_step_formulas)) {
            for (idx in 1:nrow(df_all_algorithms_with_mse_on_test)) {
              #idx<-1
              if (df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test[idx]== unique_step_formulas[jdx]) {
                df_all_algorithms_with_mse_on_test$step[idx]<- T
                
                
              }
              
              
            }
            
          }   
          #check if elnet_found_formula
          for (jdx in 1:length(unique_elnet_formulas)) {
            for (idx in 1:nrow(df_all_algorithms_with_mse_on_test)) {
              #idx<-1
              if (df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test[idx]== unique_elnet_formulas[jdx]) {
                df_all_algorithms_with_mse_on_test$elnet[idx]<- T
                
                
              }
              
              
            }
            
          }  
            
          
            step_formula_list  <-list(step_df_1_coef_save$formel,step_df_2_coef_save$formel,step_df_3_coef_save$formel,step_df_4_coef_save$formel,step_df_5_coef_save$formel)      
            rf_formula_list<- list(rf_df_1_coef_save$formel,rf_df_2_coef_save$formel,rf_df_3_coef_save$formel,rf_df_4_coef_save$formel,rf_df_5_coef_save$formel)      
            lasso_formula_list<- list(lasso_df_1_coef_save$formel,lasso_df_2_coef_save$formel,lasso_df_3_coef_save$formel,lasso_df_4_coef_save$formel,lasso_df_5_coef_save$formel, lasso_df_lambda_min_coef_save$formel,lasso_df_lambda_1se_coef_save$formel)        
            elnet_formula_list <- list(elnet_df_lambda_1se_coef_save,elnet_df_lambda_min_coef_save)
            
          build_occurence_table_methods <- function(algorithm_formula_list){  
            #algorithm_formula_list  <-lasso_formula_list
            found_formulas_list<- unique(unlist(algorithm_formula_list))
            
            algorithm_formula_df    <-   data.frame(found_formulas_list)
            unique_feature_list<-unique(unlist(str_split(found_formulas_list, " \\+ ")))
            unique_features_df<-data.frame(unique(unlist(str_split(found_formulas_list, " \\+ "))))
              
            
            df_func<-data.frame(zeros(length(found_formulas_list),length(unique_feature_list)))
            names(df_func)<-unique_feature_list
            df_func$found_formulas <- algorithm_formula_df
            
            
            #grepl(pattern = names(ff[1]), x= ff[1,ncol(ff)] )  
            for (n in 1:(ncol(df_func)-1)) {
                #n<-1
              for (row_in_col_n in 1:nrow(df_func)) {
               # print(grepl(pattern = names(df_func[n]), x= df_func[row_in_col_n,ncol(df_func)]))
                
                pat<-paste("\\b",unique_feature_list[n],"\\b", sep="")
                if(grepl(pattern = pat, x= df_func$found_formulas[row_in_col_n,])){
                  df_func[row_in_col_n,n]<-1
                }  
              }
            }
            if(any(names(df_func)==0)){ #if an algorithm hasn't found a formula with specific length
              not_select<-c(names(df_func)!=0)
              df_func<-df_func[,not_select]
            }
            return(df_func)
          }
          
          
         rf_found_formulas_and_occurence<- build_occurence_table_methods(algorithm_formula_list = rf_formula_list)
         step_found_formulas_and_occurence<- build_occurence_table_methods(algorithm_formula_list = step_formula_list)
         lasso_found_formulas_and_occurence<- build_occurence_table_methods(algorithm_formula_list = lasso_formula_list)
         #elnet_found_formulas_and_occurence<- build_occurence_table_methods(algorithm_formula_list = elnet_formula_list)
         
         get_most_selected_features <- function(found_formulas_and_occurences){
            #found_formulas_and_occurences<-rf_found_formulas_and_occurence
            most_selected_featuers_df<-data.frame(found_formulas_and_occurences[,-ncol(found_formulas_and_occurences)]%>%colMeans() ) 
            names(most_selected_featuers_df)<- "percentage"
            most_selected_featuers_df<-most_selected_featuers_df%>% arrange(desc(percentage))
          return(most_selected_featuers_df)  
          }
          
         rf_selected_features<-get_most_selected_features(rf_found_formulas_and_occurence)
         step_selected_features<-get_most_selected_features(step_found_formulas_and_occurence)
         lasso_selected_features<-get_most_selected_features(lasso_found_formulas_and_occurence)
        
         #add new formulas here
          
          
          combine_most_selected_features_table<-function(list_all_most_selected_features_1,list_unique_feature_names_1){
              g<- zeros(length(list_unique_feature_names_1),3)
              rownames(g)<- list_unique_feature_names_1
              indx_df <- 0
              for (df in list_all_most_selected_features_1) {
                
                indx_df <- indx_df +1  
               
              #df<-step_most_selected_features
                for (indx1 in 1:nrow(df)) {
                  for (indx2 in 1:nrow(g)) {
                    
                    if( rownames(g)[indx2] == rownames(df)[indx1]){
                      g[indx2,indx_df] <- df$percentage[indx1]
                    }
                  }
                }
              }
              g<- data.frame(g)
              colnames(g)<- list("step", "randomforest", "lasso")
          return(g)
          }
          
          list_unique_feature_names<-sort(unique(unlist(list(rownames(rf_selected_features),rownames(step_selected_features),rownames(lasso_selected_features)))))
          list_all_most_selected_features<-list(data.frame(step_selected_features), data.frame(rf_selected_features), data.frame(lasso_selected_features))
          all_selected_features<-combine_most_selected_features_table(list_all_most_selected_features,list_unique_feature_names)
            
          
          all_selected_features$features <- rownames(all_selected_features)
          
          common_features_found<-all_selected_features%>% filter(step !=0 & lasso!=0 & randomforest!=0)
          
          lasso_selected_features$features <- rownames(lasso_selected_features)
          rf_selected_features$features <- rownames(rf_selected_features)
          step_selected_features$features <- rownames(step_selected_features)
          
          step_selected_features$algorithm <- "step"
          lasso_selected_features$algorithm <- "lasso"
          rf_selected_features$algorithm <- "rf"
          a<-full_join(step_selected_features,lasso_selected_features)
          b<-full_join(a,rf_selected_features)%>% arrange(features, desc(percentage))
          
          
          
          
          get_most_elected_features <-function(algorithm_most_selected_features){
            
            r<-c(algorithm_most_selected_features$percentage==max(algorithm_most_selected_features$percentage))
            b<-(algorithm_most_selected_features[r,])
            return(b)
          }
          rf_most_selected_features<-get_most_elected_features(rf_selected_features)
          lasso_most_selected_features<-get_most_elected_features(lasso_selected_features)
          step_most_selected_features<-get_most_elected_features(step_selected_features)
          
          
          a<-lasso_found_formulas_and_occurence$found_formulas
          b<-step_found_formulas_and_occurence$found_formulas
          c<-rf_found_formulas_and_occurence$found_formulas
          
          a$algo <- "lasso"
          b$algo <- "step"
          c$algo <- "rf"
          
          d<-full_join(a,b)
          e<- full_join(d,c)
          
          
          #run till here for only selection
            
                     
           #linear_model_analysis<-linear_model%>% augment() #builds tidy dataframe with residuals, predictions etc
           #c<-glance(linear_model_analysis)
           #linear_model_analysis_2<-linear_model_2%>% augment()
           
         #here is actual vs predicted  
        #   plot(predict(linear_model),data_test$log_e.coli,
                #xlab="predicted",ylab="actual")
        #   abline(a=0,b=1)
           #nrow(data_test)
           
           
          # summary(linear_model)[["adj.r.squared"]]
          # summary(linear_model_)
           
           
           #par(mfrow = c(1,1))
           #plot(data_test$log_e.coli,predict(linear_model),
           #     xlab="actual",ylab="predicted" , xlim=c(-2,3), ylim=c(-2,3))
           #points(predict(linear_model_), data_test$log_e.coli, col = "red")
           #abline(a=0,b=1)
           
            #decide here which formulas will get forwarded to mcmc
           list_unqiue_formulas_all_algorithms <-df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test
           #list_unqiue_formulas_all_algorithms$n_features <- 
           a<-as.data.frame(str_count( list_unqiue_formulas_all_algorithms, pattern = "\\+") +1)
           a<- as.data.frame (a)
           df_unqiue_formulas_all_algorithms<-as.data.frame(df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test)
           df_unqiue_formulas_all_algorithms$n_features <- a
           
           max_number_features<-floor(nrow(data_test)/5)
           
           
           filtered_formulas_df<-df_unqiue_formulas_all_algorithms%>% filter(n_features<=max_number_features)
           
           list_unqiue_formulas_all_algorithms_filtered<-filtered_formulas_df$`df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test`
           #list_unqiue_formulas_all_algorithms <- list_formulas_all_algorithms[[1]]
           fb<-list()
           idx<-1
           for(idx in 1:length(list_unqiue_formulas_all_algorithms_filtered)){
            fmla[[idx]]  <- paste("log_e.coli ~ ",list_unqiue_formulas_all_algorithms[idx])
            fb[[idx]] <- lm(fmla[[idx]], data = data) #because of cross validation for mcmc
           }
           
           
           
           
           
           
           ################ Validation ########################
           
           names(fb) <- sprintf(paste0(river,"model_%02d"), seq_along(1:length(fb)))
           
           # calculate statistical tests for residuals: Normality and s2 = const
           
           # shapiro-wilk test and breusch-pagan test
           
           get_stat_tests <- function(model) {
             c(N = shapiro.test(model$residuals)$p.value, lmtest::bptest(model)$p.value,
               R2 = summary(model)[["adj.r.squared"]], n_obs = length(model$residuals))
             
           }
           
           
           
           # Eliminieren von modelled die doppelt vorkommen, da forward selection frher
           
           #fertig als n steps
           
           #heiko add fb beforehand to this
           #fb
           unique_index <- length(unique(fb))
           fb <- fb[1:unique_index]
           
           
           
           # testing for classical statistical model assumtions, normality of residuals and
           
           # heteroskelasdicity   #t() transpose
           river_stat_tests <- sapply(fb, get_stat_tests)%>%
             t() %>%
             dplyr::as_tibble(rownames = "model")  %>%
             dplyr::bind_rows(.id = "river") %>%
             dplyr::mutate(stat_correct = N > .05 & BP > .05)
           
           
           
           # creating list of independent training rows
           #-test/train split
           
           #weirde zeile, setze alle stat tests auf 0
           river_stat_tests$in95 <- river_stat_tests$below95 <-river_stat_tests$below90 <- river_stat_tests$in50 <- river_stat_tests$MSE <- 0
           
           if(first_time_model_train == 1){ #keep the same train_rows, if models were trained one after another. object should be true only when it is trained 1. time on dataset
             #crate cross validation folds
             #   train_rows <- caret::createFolds(1:nrow(fb[[paste0(river, "model_01")]]$model),
             
             #                                   k = 5, list = T, returnTrain = T)
             
             
             #}  
             #sum(foldid ==1)
             #sum(foldid ==2)
             #sum(foldid ==3) 
             #sum(foldid ==4)
             #sum(foldid ==5)
             
             #train_rows <- caret::createFolds(1:nrow(fb[[paste0(river, "model_01")]]$model),
             
             #                                k = 5, list = T, returnTrain = T)
             #train_row_id <- seq(1:nrow(data))
             #train_rows <- list()
             #for(fold in 1:5){
             #train_rows <- train_row_id[foldid!= fold]
             #train_rows[[fold]] <- train_row_id[foldid!= fold] 
             #}
           }  
           
           if(class(fmla[[length(fmla)]]) !="formula"){
             print("new element is no formula!!")
           }
           
           test_beta <- function(true, false, percentile){
             if( pbeta(q = percentile, shape1 = true + 1, shape2 = false + 1) > 0.05){
               TRUE}
             else{FALSE}
             
           }
           
           #naming models and formula
           #mcmc
           #river <- ""
           
           names(fmla) <- sprintf(paste0(river,"model_%02d"), seq_along(1:length(fb)))
           
           
           
           
           counter<-0
           
           #fb<-fb[-6]
           
           
           erro_df <- data.frame()
           
           #cross validation   needs fb, and fmla
           
           
           
           
           { 
             for(i in names(fb)){
               #i<- names(fb)[1]
               counter<- counter+1
               #i="havelmodel_01"
               test_error_df_model <- data.frame()
               assign(paste(i,"_test_error_df_model",sep = ""),test_error_df_model)
               
               for(j in 1:5){
                 counter <- counter+1
                 # j=1
                 
                 
                 training <- as.data.frame(fb[[i]]$model)[c(train_rows[[j]]),]
                 #training <- as.data.frame(fb[[6]]$model)[c(train_rows[[1]]),]
                 test <- as.data.frame(fb[[i]]$model)[-c(train_rows[[j]]),]
                 #test <- as.data.frame(fb[[6]]$model)[-c(train_rows[[1]]),]
                 #formel<-formula(formula_heiko_1)
                 
                 
                 #fmla[6]<- list(formel)
                 
                 
                 
                 fit <- rstanarm::stan_glm(fmla[[i]], data = training ) #fitting
                 #fit <- rstanarm::stan_glm(fmla[[1]], data = training) #fitting
                 
                 
                 df <- apply(rstanarm::posterior_predict(fit, newdata = test), 2, quantile, #predicting
                             
                             probs = c(0.025, 0.25, 0.5 , 0.75, 0.9, 0.95, 0.975)) %>% t() %>% as.data.frame() %>%
                   
                   dplyr::mutate(log_e.coli = test$log_e.coli, #evaluating ther model has to be classified correctly with every single test train split
                                 #--> here 5 different splits, if all validations correct than everywhere ==5
                                 
                                 below95 = log_e.coli < `95%`,
                                 
                                 below90 = log_e.coli < `90%`,
                                 
                                 within95 = log_e.coli < `97.5%`& log_e.coli > `2.5%`,
                                 
                                 within50 = log_e.coli < `75%`& log_e.coli > `25%`,
                                 
                   ) 
                 #error on testset
                 test_error_df_temp<- df%>%select(log_e.coli,`50%`)%>% mutate(squared_error = ((log_e.coli - `50%`)^2))
                 test_error_df_model<- test_error_df_model %>% rbind(test_error_df_temp)
                 
                 assign(paste(i,"_test_error_df_model", sep = ""),test_error_df_model)
                 #validation step if all percentile categories are set to 1
                 
                 river_stat_tests$in95[river_stat_tests$model == i] <-
                   
                   river_stat_tests$in95[river_stat_tests$model == i] +
                  
                   test_beta(true = sum(df$within95), false = sum(!df$within95), percentile = .95 ) #is 1 if true
                 
                 river_stat_tests$below95[river_stat_tests$model == i] <-
                   
                   river_stat_tests$below95[river_stat_tests$model == i] +
                   
                   test_beta(true = sum(df$below95), false = sum(!df$below95), percentile = .95 )
                 
                 river_stat_tests$below90[river_stat_tests$model == i] <-
                   
                   river_stat_tests$below90[river_stat_tests$model == i] +
                   
                   test_beta(true = sum(df$below90), false = sum(!df$below90), percentile = .90 )
                 
                 river_stat_tests$in50[river_stat_tests$model == i] <-
                   
                   river_stat_tests$in50[river_stat_tests$model == i] +
                   
                   
                #beta test
                   test_beta(true = sum(df$within50), false = sum(!df$within50), .5)
                 #add MSE to stat_tests
                 river_stat_tests$MSE[river_stat_tests$model == i] <- mean(test_error_df_model$squared_error)
                 
                 
                 #add selected features and coeeficients to statistical test
                 river_stat_tests$selected_features[river_stat_tests$model == i] <- list((fmla[[i]]))
                 #river_stat_tests$selected_features[river_stat_tests$model == i] <- list(all.vars(fmla[[i]]))
                 river_stat_tests$coef_selected[river_stat_tests$model == i]<- list(coef(fb[[i]]))
                 
                 
                 
               } 
               
             } 
           }
           
           
           
           
           #select only models that are validated - sorted by desc R2 - but is this a good kpi??
           sorted_modellist <- river_stat_tests %>%
             
             filter( below95 == 5 & below90 == 5& in95 ) %>%
             
             dplyr::arrange(desc(in50), MSE)  
           
           
           
           #check if formula was found by algorithm
           sorted_modellist$lasso_formula <- F
           sorted_modellist$rf_formula <- F
           sorted_modellist$step_formula <- F
           sorted_modellist$elnet_formula <- F
           
           
           for (idx in 1: nrow(sorted_modellist)) {
             #idx<-1
             selected_features_posterior<-sorted_modellist[idx,]$selected_features[[1]][1]
             g<-str_split(selected_features_posterior,"~  ")
             l<-g[[1]][2]
             
             if(!is.na(match(l,unlist(unique_lasso_formulas)))){
               sorted_modellist$lasso_formula[idx] =T
             }else if(!is.na(match(l,unlist(unique_rf_formulas)))){
               sorted_modellist$rf_formula[idx] =T
             }else if(!is.na(match(l,unlist(unique_step_formulas)))){
               sorted_modellist$step_formula[idx] =T
             }else if(!is.na(match(l,unlist(unique_elnet_formulas)))){
               sorted_modellist$elnet_formula[idx] =T
             }
           }
           
           
           #how 
           #sum(sorted_modellist$lasso_formula==T)/nrow(sorted_modellist)
           #sum(sorted_modellist$rf_formula==T)/nrow(sorted_modellist)
           #sum(sorted_modellist$step_formula==T)/nrow(sorted_modellist)
           
           selected_features_posterior<-sorted_modellist[4,]$selected_features[[1]][1]
           g<-str_split(selected_features_posterior,"~  ")
           l<-g[[1]][2]
           match(l,unlist(unique_lasso_formulas))
           match(l,unlist(unique_rf_formulas))
           match(l,unlist(unique_step_formulas))
           i = sorted_modellist$model[1]
           fb
           
           #gives back best model
           best_model_r_2<-fb[names(fb) == i]
           fb[[4]]%>% augment()
           best_model_r_2 %>% augment()
           
           
           par(mfrow = c(1,1))
           plot(model_04_test_error_df_model$log_e.coli ,model_04_test_error_df_model$`50%`,
                xlab="actual",ylab="predicted", xlim=c(-2,3), ylim=c(-2,3))
           #points(predict(linear_model_), data_test$log_e.coli, col = "red")
           abline(a=0,b=1)
           
           #fmla
           
           #needed to be sure to not change train_rows while analyzing the same dataset with different algorithms
           first_time_model_train <- first_time_model_train +1
           
           if(do_lasso ==T ){
             #
             river_stat_tests$model = paste(river_stat_tests$model,"_lasso",sep = "")
             names(fmla) = paste(names(fmla),"_lasso",sep = "")
             names(fb)  = paste(names(fb),"_lasso",sep = "")
             
             for (entry in 1:nrow(river_stat_tests)) {
               if (entry==1) {
                 new_add<- "_1se"
                 river_stat_tests$model[entry] = paste(river_stat_tests$model[entry], new_add, sep = "")
                 names(fmla)[entry] <- paste(names(fmla)[entry], new_add, sep = "")
                 names(fb)[entry]  = paste(names(fb)[entry],new_add,sep = "")
                 
               }else if (entry==2) {
                 new_add<- "_1se_stand"
                 river_stat_tests$model[entry] = paste(river_stat_tests$model[entry], new_add, sep = "")
                 names(fmla)[entry] <- paste(names(fmla)[entry], new_add, sep = "")
                 names(fb)[entry]  = paste(names(fb)[entry],new_add,sep = "")
               }else if (entry==3) {
                 new_add<- "_lambda_min"
                 river_stat_tests$model[entry] = paste(river_stat_tests$model[entry], new_add, sep = "")
                 names(fmla)[entry] <- paste(names(fmla)[entry], new_add, sep = "")
                 names(fb)[entry]  = paste(names(fb)[entry],new_add,sep = "")
               }else if (entry==4) {
                 new_add<- "_lambda_min_stand"
                 river_stat_tests$model[entry] = paste(river_stat_tests$model[entry], new_add, sep = "")
                 names(fmla)[entry] <- paste(names(fmla)[entry], new_add, sep = "")
                 names(fb)[entry]  = paste(names(fb)[entry],new_add,sep = "")
               }
               
             }
           }
           
           
           
                    river<-"Ruhr"

```

The models were trained with data from `r river` with `r nrow(data) ` number of observations and `r ncol(data)` number of features/variables.
With 2 nteractions between the features the feature-selection algorithms have `r ncol(df_with_all_variable_names)` to choose from.

As described in the last results, there are 2 train/test splits in this code.
The first one does an 80%/20% train/test split to examine the performance after the featureselection.
The second one is done within the feature-selection process, because the chosen features from Random-Forest and Stepwise regression are very dependend on the train/test split. To not miss a possible formula all ever found formulas will get tested against the first test-split.


During the selection process were `r length(list_formulas_all_algorithms[[1]])` different formulas selected with `r nrow(all_most_selected_features)` features.

The selected features and their percentage occurences are summarised in the following table:

```{r}
print(all_most_selected_features, n = 100)
```

The 1  selected features for Lasso are:
`r lasso_selected_features `
The 1 selected features for random forest are:
`r rf_selected_features `
The 1 selected features forest for Step are:
`r step_selected_features `


The common features they chose and their occurences are:
```{r}
common_features_found
```
--> seems like r_mean_mean_123 and ka_mean_mean_12 are two important features for our model (r_mean_mean_12 and r_mean_mean_23 are strongly correlated to r_mean_mean_123)


Lasso builded  `r nrow(lasso_found_formulas_and_occurence)` different formulas out of the following  `r ncol(lasso_found_formulas_and_occurence)-1` different features with the following occurences:
`r lasso_found_formulas_and_occurence[-ncol(lasso_found_formulas_and_occurence)]`
```{r echo=FALSE}
lasso_found_formulas_and_occurence$found_formulas
```

Lasso with the lambda value that led to the MSE in the Selection process selected the formulas:  
" `r lasso_lambda_min_selected_features_in_different_train_test_splits$formel` "  
with `r lasso_lambda_min_selected_features_in_different_train_test_splits$n_features` features

Lasso with the lambda value that led to 1standard deviation away from the mse in the Selection process selected the formulas:
"`r lasso_lambda_1se_selected_features_in_different_train_test_splits$formel`"  
with `r lasso_lambda_1se_selected_features_in_different_train_test_splits$n_features` features



Random Forest builded  `r nrow(rf_found_formulas_and_occurence)` different formulas out of the following  `r ncol(rf_found_formulas_and_occurence)-1` different features with the following occurences:
`r rf_found_formulas_and_occurence[-ncol(rf_found_formulas_and_occurence)]`

```{r echo=FALSE}
rf_found_formulas_and_occurence$found_formulas
```

Step  builded  `r nrow(step_found_formulas_and_occurence)` different formulas out of the following  `r ncol(step_found_formulas_and_occurence)-1` different features with the following occurences:
`r step_found_formulas_and_occurence[-ncol(step_found_formulas_and_occurence)]`

```{r echo=FALSE}
step_found_formulas_and_occurence$found_formulas
```



The Following dataframes contain the found formulas with 1-5 features and how often they were selected from each of the selection-algorithms.

`r occurence_feature_1_analysis`

`r occurence_feature_2_analysis`

`r occurence_feature_3_analysis`

`r occurence_feature_4_analysis`

`r occurence_feature_5_analysis`


With the Test set the mean squared errors for the unique formulas were calculated. Additionally 4 columns were added to check if the formula was found by the selection algorithms.

```{r}
df_all_algorithms_with_mse_on_test
```

The formula with the smalles MSE on Test-set was found by: elnet with `r str_count(df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test[1], pattern = "\\+")+1` features

The formula with the second smalles MSE on Test-set was found by: lasso with `r str_count(df_all_algorithms_with_mse_on_test$formula_with_lowest_mse_on_test[2], pattern = "\\+")+1` features
 
As we only have 58 Datapoints in our Test/set and rhe first two models so many features the model will most likely overfit and it will most likely not converge in the MCMC-sampling
As rule of thumb all formulas will be dropped that have less than 5 datapoints per feature (here first and second)


With the validation procedure the following sorted_modellist was produced and sorted for an ascending MSE

```{r}
sorted_modellist
```

The 6 formulas with the lowest MSe were all found by the step_function
-7, 9, and 10 from random_forest



